"use strict";

define(['../core/core', '../core/event', '../tt/property/index', '../tt/list/index', '../tt/util'], function (core, event, property, list, util) {
  var TtNode = function TtNode() {
    this.init.apply(this, arguments);
  };

  TtNode.prototype = {
    init: function init(params) {
      // create dom node
      this.domNode = document.createElement(params.type);
      this.domNode.__ttNode = this; // parse properties

      for (var propertyName in params) {
        var propertyValue = params[propertyName];

        switch (propertyName) {
          case 'type':
            break;

          case 'data':
            this.data = propertyValue;
            break;

          case 'click':
          case 'change':
          case 'drag':
          case 'dragstart':
          case 'dragover':
          case 'dragenter':
          case 'dragleave':
          case 'dragend':
          case 'drop':
          case 'input':
          case 'blur':
            this.setupEventHandler(propertyName, propertyValue);
            break;

          default:
            this.setupAttribute(propertyName, propertyValue);
        }
      }
    },
    delete: function _delete() {
      this.domNode.parentNode.removeChild(this.domNode);

      if (this.children) {
        for (var i = 0; i < this.children.length; ++i) {
          var child = this.children[i];
          child.delete();
        }
      }

      event.delete(this);
    },
    getDomNode: function getDomNode() {
      return this.domNode;
    },
    setupAttribute: function setupAttribute(name, value) {
      if (!value) {
        return;
      }

      this.generateSetter(name);

      switch (core.getType(value)) {
        case 'function':
          // generate setter
          var calc = value; // create calculated attribute

          property.createCalculatedProperty(this, name, calc); // subscribe

          event.addEventHandler(this, util.methodName('set', name), this, this.dummy);
          break;

        default:
          // call setter
          var methodName = util.methodName('set', name);
          this[methodName].apply(this, [value]);
          break;
      }
    },
    generateSetter: function generateSetter(name) {
      var methodName = util.methodName('set', name);

      if (this[methodName]) {
        return;
      }

      this[methodName] = function (value) {
        this.setDomAttribute(name, value);
      };
    },
    dummy: function dummy() {},
    setDomAttribute: function setDomAttribute(name, value) {
      if (name === 'text') {
        if (value != this.domNode.innerText) {
          this.domNode.innerText = value;
        }

        return;
      }

      if (name === 'value' && this.domNode.tagName === 'INPUT') {
        if (this.domNode.value != value) {
          this.domNode.value = value;
        }

        return;
      }

      if (name === '_type') {
        name = 'type';
      }

      this.domNode.setAttribute(name, value);
    },
    setupEventHandler: function setupEventHandler(event, handler) {
      this.domNode.addEventListener(event, handler);
    },
    setChildren: function setChildren(children) {
      if (this.children) {
        event.removeEventHandler(this.children, 'splice', this, this.spliceChildren);
      }

      this.children = children;
      list.initList(this.children);
      this.initChildren = true;
      event.addEventHandler(this.children, 'splice', this, this.spliceChildren);
      this.initChildren = false;

      while (this.domNode.firstElementChild) {
        var domChildNode = this.domNode.firstElementChild;

        domChildNode.__ttNode.delete();
      }

      for (var i = 0; i < this.children.length; ++i) {
        var child = this.children[i];
        this.domNode.appendChild(child.getDomNode());
      }
    },
    setCss: function setCss(css) {
      if (this.css) {
        event.removeEventHandler(this.css, 'splice', this, this.spliceCss);
      }

      this.css = css;
      this.internalCss = this.css.slice();
      list.initList(this.css);
      this.initCss = true;
      event.addEventHandler(this.css, 'splice', this, this.spliceCss);
      this.initCss = false;
      this.domNode.className = '';

      for (i = 0; i < this.css.length; ++i) {
        var cssClass = this.css[i];
        this.domNode.classList.add(cssClass);
      }
    },
    spliceChildren: function spliceChildren(signal, spliceArgs) {
      if (this.initChildren) {
        return;
      }

      var index = spliceArgs[0];
      var numDel = spliceArgs[1];
      var insertNodes = spliceArgs.slice(2);

      for (var i = 0; i < numDel; ++i) {
        var domChildNode = this.domNode.children[index];

        domChildNode.__ttNode.delete();
      }

      for (i = 0; i < insertNodes.length; ++i) {
        var insertNode = insertNodes[i];

        if (index < this.domNode.children.length) {
          var refNode = this.domNode.children[index];
          this.domNode.insertBefore(insertNode.domNode, refNode);
        } else {
          this.domNode.appendChild(insertNode.domNode);
        }

        index += 1;
      }
    },
    spliceCss: function spliceCss(signal, spliceArgs) {
      if (this.initCss) {
        return;
      }

      var index = spliceArgs[0];
      var numDel = spliceArgs[1];
      var insertCss = spliceArgs.slice(2);
      var cssClass;

      for (var i = 0; i < numDel; ++i) {
        cssClass = this.internalCss[index + i];
        this.domNode.classList.remove(cssClass);
      }

      for (i = 0; i < insertCss.length; ++i) {
        cssClass = insertCss[i];
        this.domNode.classList.add(cssClass);
      }

      core.splice(this.internalCss, index, numDel, insertCss);
    }
  };
  return TtNode;
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kb20vVHROb2RlLmpzIl0sIm5hbWVzIjpbImRlZmluZSIsImNvcmUiLCJldmVudCIsInByb3BlcnR5IiwibGlzdCIsInV0aWwiLCJUdE5vZGUiLCJpbml0IiwiYXBwbHkiLCJhcmd1bWVudHMiLCJwcm90b3R5cGUiLCJwYXJhbXMiLCJkb21Ob2RlIiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50IiwidHlwZSIsIl9fdHROb2RlIiwicHJvcGVydHlOYW1lIiwicHJvcGVydHlWYWx1ZSIsImRhdGEiLCJzZXR1cEV2ZW50SGFuZGxlciIsInNldHVwQXR0cmlidXRlIiwiZGVsZXRlIiwicGFyZW50Tm9kZSIsInJlbW92ZUNoaWxkIiwiY2hpbGRyZW4iLCJpIiwibGVuZ3RoIiwiY2hpbGQiLCJnZXREb21Ob2RlIiwibmFtZSIsInZhbHVlIiwiZ2VuZXJhdGVTZXR0ZXIiLCJnZXRUeXBlIiwiY2FsYyIsImNyZWF0ZUNhbGN1bGF0ZWRQcm9wZXJ0eSIsImFkZEV2ZW50SGFuZGxlciIsIm1ldGhvZE5hbWUiLCJkdW1teSIsInNldERvbUF0dHJpYnV0ZSIsImlubmVyVGV4dCIsInRhZ05hbWUiLCJzZXRBdHRyaWJ1dGUiLCJoYW5kbGVyIiwiYWRkRXZlbnRMaXN0ZW5lciIsInNldENoaWxkcmVuIiwicmVtb3ZlRXZlbnRIYW5kbGVyIiwic3BsaWNlQ2hpbGRyZW4iLCJpbml0TGlzdCIsImluaXRDaGlsZHJlbiIsImZpcnN0RWxlbWVudENoaWxkIiwiZG9tQ2hpbGROb2RlIiwiYXBwZW5kQ2hpbGQiLCJzZXRDc3MiLCJjc3MiLCJzcGxpY2VDc3MiLCJpbnRlcm5hbENzcyIsInNsaWNlIiwiaW5pdENzcyIsImNsYXNzTmFtZSIsImNzc0NsYXNzIiwiY2xhc3NMaXN0IiwiYWRkIiwic2lnbmFsIiwic3BsaWNlQXJncyIsImluZGV4IiwibnVtRGVsIiwiaW5zZXJ0Tm9kZXMiLCJpbnNlcnROb2RlIiwicmVmTm9kZSIsImluc2VydEJlZm9yZSIsImlu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RSxNQUFNLEdBQUdGLFVBQVUsQ0FBQyxDQUFELENBQXZCO0FBQ0EsVUFBSU8sU0FBUyxHQUFHUCxVQUFVLENBQUNQLEtBQVgsQ0FBaUIsQ0FBakIsQ0FBaEI7QUFDQSxVQUFJRyxRQUFKOztBQUNBLFdBQUssSUFBSWxDLENBQUMsR0FBRyxDQUFiLEVBQWdCQSxDQUFDLEdBQUd3QyxNQUFwQixFQUE0QixFQUFFeEMsQ0FBOUIsRUFBaUM7QUFDN0JrQyxRQUFBQSxRQUFRLEdBQUcsS0FBS0osV0FBTCxDQUFpQlMsS0FBSyxHQUFHdkMsQ0FBekIsQ0FBWDtBQUNBLGFBQUtkLE9BQUwsQ0FBYWlELFNBQWIsQ0FBdUJXLE1BQXZCLENBQThCWixRQUE5QjtBQUNIOztBQUVELFdBQUtsQyxDQUFDLEdBQUcsQ0FBVCxFQUFZQSxDQUFDLEdBQUc2QyxTQUFTLENBQUM1QyxNQUExQixFQUFrQyxFQUFFRCxDQUFwQyxFQUF1QztBQUNuQ2tDLFFBQUFBLFFBQVEsR0FBR1csU0FBUyxDQUFDN0MsQ0FBRCxDQUFwQjtBQUNBLGFBQUtkLE9BQUwsQ0FBYWlELFNBQWIsQ0FBdUJDLEdBQXZCLENBQTJCRixRQUEzQjtBQUNIOztBQUNEM0QsTUFBQUEsSUFBSSxDQUFDd0UsTUFBTCxDQUFZLEtBQUtqQixXQUFqQixFQUE4QlMsS0FBOUIsRUFBcUNDLE1BQXJDLEVBQTZDSyxTQUE3QztBQUNIO0FBaE1jLEdBQW5CO0FBbU1BLFNBQU9qRSxNQUFQO0FBQ0gsQ0ExTUssQ0FBTiIsInNvdXJjZXNDb250ZW50IjpbImRlZmluZShbJy4uL2NvcmUvY29yZScsICcuLi9jb3JlL2V2ZW50JywgJy4uL3R0L3Byb3BlcnR5L2luZGV4JywgJy4uL3R0L2xpc3QvaW5kZXgnLCAnLi4vdHQvdXRpbCddLCBmdW5jdGlvbiAoY29yZSwgZXZlbnQsIHByb3BlcnR5LCBsaXN0LCB1dGlsKSB7XG5cbiAgICB2YXIgVHROb2RlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB0aGlzLmluaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICB9O1xuXG4gICAgVHROb2RlLnByb3RvdHlwZSA9IHtcblxuICAgICAgICBpbml0OiBmdW5jdGlvbiAocGFyYW1zKSB7XG5cbiAgICAgICAgICAgIC8vIGNyZWF0ZSBkb20gbm9kZVxuICAgICAgICAgICAgdGhpcy5kb21Ob2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChwYXJhbXMudHlwZSk7XG4gICAgICAgICAgICB0aGlzLmRvbU5vZGUuX190dE5vZGUgPSB0aGlzO1xuXG4gICAgICAgICAgICAvLyBwYXJzZSBwcm9wZXJ0aWVzXG4gICAgICAgICAgICBmb3IgKHZhciBwcm9wZXJ0eU5hbWUgaW4gcGFyYW1zKSB7XG4gICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5VmFsdWUgPSBwYXJhbXNbcHJvcGVydHlOYW1lXTtcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKHByb3BlcnR5TmFtZSkge1xuICAgICAgICAgICAgICAgICAgICBjYXNlICd0eXBlJzpcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBjYXNlICdkYXRhJzpcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGF0YSA9IHByb3BlcnR5VmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnY2xpY2snOlxuICAgICAgICAgICAgICAgICAgICBjYXNlICdjaGFuZ2UnOlxuICAgICAgICAgICAgICAgICAgICBjYXNlICdkcmFnJzpcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnZHJhZ3N0YXJ0JzpcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnZHJhZ292ZXInOlxuICAgICAgICAgICAgICAgICAgICBjYXNlICdkcmFnZW50ZXInOlxuICAgICAgICAgICAgICAgICAgICBjYXNlICdkcmFnbGVhdmUnOlxuICAgICAgICAgICAgICAgICAgICBjYXNlICdkcmFnZW5kJzpcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnZHJvcCc6XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2lucHV0JzpcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnYmx1cic6XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldHVwRXZlbnRIYW5kbGVyKHByb3BlcnR5TmFtZSwgcHJvcGVydHlWYWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0dXBBdHRyaWJ1dGUocHJvcGVydHlOYW1lLCBwcm9wZXJ0eVZhbHVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSxcblxuICAgICAgICBkZWxldGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHRoaXMuZG9tTm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMuZG9tTm9kZSk7XG4gICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbikge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSB0aGlzLmNoaWxkcmVuW2ldO1xuICAgICAgICAgICAgICAgICAgICBjaGlsZC5kZWxldGUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBldmVudC5kZWxldGUodGhpcyk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgZ2V0RG9tTm9kZTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9tTm9kZTtcbiAgICAgICAgfSxcblxuICAgICAgICBzZXR1cEF0dHJpYnV0ZTogZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7XG5cbiAgICAgICAgICAgIGlmICghdmFsdWUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuZ2VuZXJhdGVTZXR0ZXIobmFtZSk7XG5cbiAgICAgICAgICAgIHN3aXRjaCAoY29yZS5nZXRUeXBlKHZhbHVlKSkge1xuICAgICAgICAgICAgICAgIGNhc2UgJ2Z1bmN0aW9uJzpcbiAgICAgICAgICAgICAgICAgICAgLy8gZ2VuZXJhdGUgc2V0dGVyXG4gICAgICAgICAgICAgICAgICAgIHZhciBjYWxjID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBjYWxjdWxhdGVkIGF0dHJpYnV0ZVxuICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eS5jcmVhdGVDYWxjdWxhdGVkUHJvcGVydHkodGhpcywgbmFtZSwgY2FsYyk7XG4gICAgICAgICAgICAgICAgICAgIC8vIHN1YnNjcmliZVxuICAgICAgICAgICAgICAgICAgICBldmVudC5hZGRFdmVudEhhbmRsZXIodGhpcywgdXRpbC5tZXRob2ROYW1lKCdzZXQnLCBuYW1lKSwgdGhpcywgdGhpcy5kdW1teSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgIC8vIGNhbGwgc2V0dGVyXG4gICAgICAgICAgICAgICAgICAgIHZhciBtZXRob2ROYW1lID0gdXRpbC5tZXRob2ROYW1lKCdzZXQnLCBuYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpc1ttZXRob2ROYW1lXS5hcHBseSh0aGlzLCBbdmFsdWVdKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSxcblxuICAgICAgICBnZW5lcmF0ZVNldHRlcjogZnVuY3Rpb24gKG5hbWUpIHtcbiAgICAgICAgICAgIHZhciBtZXRob2ROYW1lID0gdXRpbC5tZXRob2ROYW1lKCdzZXQnLCBuYW1lKTtcbiAgICAgICAgICAgIGlmICh0aGlzW21ldGhvZE5hbWVdKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpc1ttZXRob2ROYW1lXSA9IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0RG9tQXR0cmlidXRlKG5hbWUsIHZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcblxuICAgICAgICBkdW1teTogZnVuY3Rpb24gKCkge1xuXG4gICAgICAgIH0sXG5cbiAgICAgICAgc2V0RG9tQXR0cmlidXRlOiBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHtcbiAgICAgICAgICAgIGlmIChuYW1lID09PSAndGV4dCcpIHtcbiAgICAgICAgICAgICAgICBpZiAodmFsdWUgIT0gdGhpcy5kb21Ob2RlLmlubmVyVGV4dCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRvbU5vZGUuaW5uZXJUZXh0ID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChuYW1lID09PSAndmFsdWUnICYmIHRoaXMuZG9tTm9kZS50YWdOYW1lID09PSAnSU5QVVQnKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZG9tTm9kZS52YWx1ZSAhPSB2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRvbU5vZGUudmFsdWUgPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdfdHlwZScpIHtcbiAgICAgICAgICAgICAgICBuYW1lID0gJ3R5cGUnO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5kb21Ob2RlLnNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgc2V0dXBFdmVudEhhbmRsZXI6IGZ1bmN0aW9uIChldmVudCwgaGFuZGxlcikge1xuICAgICAgICAgICAgdGhpcy5kb21Ob2RlLmFkZEV2ZW50TGlzdGVuZXIoZXZlbnQsIGhhbmRsZXIpO1xuICAgICAgICB9LFxuXG4gICAgICAgIHNldENoaWxkcmVuOiBmdW5jdGlvbiAoY2hpbGRyZW4pIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmNoaWxkcmVuKSB7XG4gICAgICAgICAgICAgICAgZXZlbnQucmVtb3ZlRXZlbnRIYW5kbGVyKHRoaXMuY2hpbGRyZW4sICdzcGxpY2UnLCB0aGlzLCB0aGlzLnNwbGljZUNoaWxkcmVuKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbjtcbiAgICAgICAgICAgIGxpc3QuaW5pdExpc3QodGhpcy5jaGlsZHJlbik7XG4gICAgICAgICAgICB0aGlzLmluaXRDaGlsZHJlbiA9IHRydWU7XG4gICAgICAgICAgICBldmVudC5hZGRFdmVudEhhbmRsZXIodGhpcy5jaGlsZHJlbiwgJ3NwbGljZScsIHRoaXMsIHRoaXMuc3BsaWNlQ2hpbGRyZW4pO1xuICAgICAgICAgICAgdGhpcy5pbml0Q2hpbGRyZW4gPSBmYWxzZTtcbiAgICAgICAgICAgIHdoaWxlICh0aGlzLmRvbU5vZGUuZmlyc3RFbGVtZW50Q2hpbGQpIHtcbiAgICAgICAgICAgICAgICB2YXIgZG9tQ2hpbGROb2RlID0gdGhpcy5kb21Ob2RlLmZpcnN0RWxlbWVudENoaWxkO1xuICAgICAgICAgICAgICAgIGRvbUNoaWxkTm9kZS5fX3R0Tm9kZS5kZWxldGUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IHRoaXMuY2hpbGRyZW5baV07XG4gICAgICAgICAgICAgICAgdGhpcy5kb21Ob2RlLmFwcGVuZENoaWxkKGNoaWxkLmdldERvbU5vZGUoKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG5cbiAgICAgICAgc2V0Q3NzOiBmdW5jdGlvbiAoY3NzKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5jc3MpIHtcbiAgICAgICAgICAgICAgICBldmVudC5yZW1vdmVFdmVudEhhbmRsZXIodGhpcy5jc3MsICdzcGxpY2UnLCB0aGlzLCB0aGlzLnNwbGljZUNzcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmNzcyA9IGNzcztcbiAgICAgICAgICAgIHRoaXMuaW50ZXJuYWxDc3MgPSB0aGlzLmNzcy5zbGljZSgpO1xuICAgICAgICAgICAgbGlzdC5pbml0TGlzdCh0aGlzLmNzcyk7XG4gICAgICAgICAgICB0aGlzLmluaXRDc3MgPSB0cnVlO1xuICAgICAgICAgICAgZXZlbnQuYWRkRXZlbnRIYW5kbGVyKHRoaXMuY3NzLCAnc3BsaWNlJywgdGhpcywgdGhpcy5zcGxpY2VDc3MpO1xuICAgICAgICAgICAgdGhpcy5pbml0Q3NzID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLmRvbU5vZGUuY2xhc3NOYW1lID0gJyc7XG4gICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5jc3MubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgICAgICAgICB2YXIgY3NzQ2xhc3MgPSB0aGlzLmNzc1tpXTtcbiAgICAgICAgICAgICAgICB0aGlzLmRvbU5vZGUuY2xhc3NMaXN0LmFkZChjc3NDbGFzcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG5cbiAgICAgICAgc3BsaWNlQ2hpbGRyZW46IGZ1bmN0aW9uIChzaWduYWwsIHNwbGljZUFyZ3MpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmluaXRDaGlsZHJlbikge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBpbmRleCA9IHNwbGljZUFyZ3NbMF07XG4gICAgICAgICAgICB2YXIgbnVtRGVsID0gc3BsaWNlQXJnc1sxXTtcbiAgICAgICAgICAgIHZhciBpbnNlcnROb2RlcyA9IHNwbGljZUFyZ3Muc2xpY2UoMik7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG51bURlbDsgKytpKSB7XG4gICAgICAgICAgICAgICAgdmFyIGRvbUNoaWxkTm9kZSA9IHRoaXMuZG9tTm9kZS5jaGlsZHJlbltpbmRleF07XG4gICAgICAgICAgICAgICAgZG9tQ2hpbGROb2RlLl9fdHROb2RlLmRlbGV0ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGluc2VydE5vZGVzLmxlbmd0aDsgKytpKSB7XG4gICAgICAgICAgICAgICAgdmFyIGluc2VydE5vZGUgPSBpbnNlcnROb2Rlc1tpXTtcbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPCB0aGlzLmRvbU5vZGUuY2hpbGRyZW4ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciByZWZOb2RlID0gdGhpcy5kb21Ob2RlLmNoaWxkcmVuW2luZGV4XTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kb21Ob2RlLmluc2VydEJlZm9yZShpbnNlcnROb2RlLmRvbU5vZGUsIHJlZk5vZGUpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZG9tTm9kZS5hcHBlbmRDaGlsZChpbnNlcnROb2RlLmRvbU5vZGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpbmRleCArPSAxO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuXG4gICAgICAgIHNwbGljZUNzczogZnVuY3Rpb24gKHNpZ25hbCwgc3BsaWNlQXJncykge1xuICAgICAgICAgICAgaWYgKHRoaXMuaW5pdENzcykge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBpbmRleCA9IHNwbGljZUFyZ3NbMF07XG4gICAgICAgICAgICB2YXIgbnVtRGVsID0gc3BsaWNlQXJnc1sxXVxuICAgICAgICAgICAgdmFyIGluc2VydENzcyA9IHNwbGljZUFyZ3Muc2xpY2UoMik7XG4gICAgICAgICAgICB2YXIgY3NzQ2xhc3M7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG51bURlbDsgKytpKSB7XG4gICAgICAgICAgICAgICAgY3NzQ2xhc3MgPSB0aGlzLmludGVybmFsQ3NzW2luZGV4ICsgaV07XG4gICAgICAgICAgICAgICAgdGhpcy5kb21Ob2RlLmNsYXNzTGlzdC5yZW1vdmUoY3NzQ2xhc3MpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaW5zZXJ0Q3NzLmxlbmd0aDsgKytpKSB7XG4gICAgICAgICAgICAgICAgY3NzQ2xhc3MgPSBpbnNlcnRDc3NbaV07XG4gICAgICAgICAgICAgICAgdGhpcy5kb21Ob2RlLmNsYXNzTGlzdC5hZGQoY3NzQ2xhc3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29yZS5zcGxpY2UodGhpcy5pbnRlcm5hbENzcywgaW5kZXgsIG51bURlbCwgaW5zZXJ0Q3NzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBUdE5vZGU7XG59KTsiXX0=