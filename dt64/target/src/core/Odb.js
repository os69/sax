"use strict";

(function () {
  // =======================================================================
  // odb
  // =======================================================================
  var Odb = function Odb() {
    this.init.apply(this, arguments);
  };

  Odb.prototype = {
    init: function init() {
      this.clsMap = {};
      this.maxId = 0;
    },
    generateId: function generateId() {
      return '#' + ++this.maxId;
    },
    isReference: function isReference(value) {
      return value && value[0] === '#';
    },
    ignoreProperty: function ignoreProperty(property) {
      return property === '__admin__' || property.slice(0, 2) === '__';
    },
    type: function type(obj) {
      switch (typeof obj) {
        case 'string':
        case 'number':
        case 'boolean':
          return 'simple';

        case 'function':
          return 'function';

        case 'object':
          if (Array.isArray(obj)) {
            return 'list';
          } else {
            return 'object';
          }

      }
    },
    create: function create(type, name) {
      var obj;

      switch (type) {
        case 'object':
          if (!name) {
            obj = {};
          } else {
            cls = this.clsMap[name];
            obj = Object.create(cls.prototype);
          }

          break;

        case 'list':
          obj = [];
          break;

        default:
          throw 'illegal type';
      }

      this.getObjectAdminData(obj);
      return obj;
    },
    registerClass: function registerClass(constructor) {
      this.clsMap[constructor.prototype.meta.name] = constructor;
    },
    getObjectAdminData: function getObjectAdminData(obj) {
      var name = obj.meta && obj.meta.name;

      if (name) {
        this.clsMap[name] = obj.constructor;
      }

      ;

      if (!obj.__admin__) {
        obj.__admin__ = {
          id: this.generateId(),
          name: name
        };
      }

      return obj.__admin__;
    },
    clone: function clone(obj) {
      var cloner = new Cloner(this);
      return cloner.clone(obj);
    },
    toJson: function toJson(obj) {
      var serializer = new Serializer(this);
      return serializer.toJson(obj);
    },
    fromJson: function fromJson(json) {
      var deSerializer = new DeSerializer(this);
      return deSerializer.fromJson(json);
    }
  }; // =======================================================================
  // de-serializer
  // =======================================================================

  var DeSerializer = function DeSerializer() {
    this.init.apply(this, arguments);
  };

  DeSerializer.prototype = {
    init: function init(odb) {
      this.odb = odb;
    },
    processObjects: function processObjects(json) {
      var objects = {};

      for (var id in json.objects) {
        var jsonObj = json.objects[id];
        var object;

        switch (this.odb.type(jsonObj)) {
          case 'object':
            object = this.odb.create('object', jsonObj.__admin__.name);

            for (var property in jsonObj) {
              if (this.odb.ignoreProperty(property)) {
                continue;
              }

              object[property] = jsonObj[property];
            }

            break;

          case 'list':
            object = this.odb.create('list');

            for (var i = 0; i < jsonObj.length; ++i) {
              var element = jsonObj[i];
              object.push(element);
            }

            break;

          default:
            throw 'illegal type';
        }

        objects[id] = object;
      }

      return objects;
    },
    processRelations: function processRelations(json, objects) {
      for (var id in objects) {
        object = objects[id];
        var refObjId;

        switch (this.odb.type(object)) {
          case 'object':
            for (var property in object) {
              if (this.odb.ignoreProperty(property)) {
                continue;
              }

              refObjId = object[property];

              if (this.odb.isReference(refObjId)) {
                object[property] = objects[refObjId];
              }
            }

            break;

          case 'list':
            for (i = 0; i < object.length; ++i) {
              refObjId = object[i];

              if (this.odb.isReference(refObjId)) {
                object[i] = objects[refObjId];
              }
            }

            break;

          default:
            throw 'illegal type';
        }
      }
    },
    postProcessObjects: function postProcessObjects(objects) {
      for (var id in objects) {
        var object = objects[id];

        if (object.postDeSerialize) {
          object.postDeSerialize();
        }
      }
    },
    fromJson: function fromJson(json) {
      // objects
      var objects = this.processObjects(json); // relations

      this.processRelations(json, objects); // post process objects

      this.postProcessObjects(objects); // return root object

      return objects[json.rootId];
    }
  }; // =======================================================================
  // serializer
  // =======================================================================

  var ignore = {};

  var Serializer = function Serializer() {
    this.init.apply(this, arguments);
  };

  Serializer.prototype = {
    init: function init(odb) {
      this.odb = odb;
      this.json = {
        rootId: null,
        objects: {}
      };
    },
    toJson: function toJson(obj) {
      this._toJson(obj);

      return this.json;
    },
    _putJson: function _putJson(obj) {
      this.json.objects[obj.__admin__.id] = obj;

      if (!this.json.rootId) {
        this.json.rootId = obj.__admin__.id;
      }
    },
    _getJson: function _getJson(id) {
      return this.json.objects[id];
    },
    _toJson: function _toJson(obj) {
      switch (this.odb.type(obj)) {
        case 'simple':
          return obj;

        case 'object':
          return this._toJsonObject(obj);

        case 'list':
          return this._toJsonList(obj);

        case 'function':
          return ignore;
      }
    },
    _toJsonObject: function _toJsonObject(obj) {
      if (obj === null) {
        return null;
      }

      if (obj.meta && obj.meta.serialize !== undefined && !obj.meta.serialize) {
        return ignore;
      }

      var admin = this.odb.getObjectAdminData(obj);

      var jsonObj = this._getJson(admin.id);

      if (jsonObj) {
        return jsonObj.__admin__.id;
      }

      var jsonObj = {};
      jsonObj.__admin__ = obj.__admin__;

      this._putJson(jsonObj);

      for (var key in obj) {
        var value = obj[key];

        if (!obj.hasOwnProperty(key)) {
          continue;
        }

        if (this.odb.ignoreProperty(key)) {
          continue;
        }

        var referenceId = this._toJson(value);

        if (referenceId === ignore) {
          continue;
        }

        jsonObj[key] = referenceId;
      }

      return jsonObj.__admin__.id;
    },
    _toJsonList: function _toJsonList(obj) {
      if (obj.meta && obj.meta.serialize !== undefined && !obj.meta.serialize) {
        return ignore;
      }

      var admin = this.odb.getObjectAdminData(obj);

      var jsonObj = this._getJson(admin.id);

      if (jsonObj) {
        return jsonObj.__admin__.id;
      }

      jsonObj = [];
      jsonObj.__admin__ = obj.__admin__;

      this._putJson(jsonObj);

      for (var i = 0; i < obj.length; ++i) {
        var value = obj[i];

        var referenceId = this._toJson(value);

        if (referenceId === ignore) {
          continue;
        }

        jsonObj.push(referenceId);
      }

      return jsonObj.__admin__.id;
    }
  }; // =======================================================================
  // cloner
  // =======================================================================

  var Cloner = function Cloner() {
    this.init.apply(this, arguments);
  };

  Cloner.prototype = {
    init: function init(odb) {
      this.odb = odb;
      this.cloneMap = {};
    },
    clone: function clone(obj) {
      switch (this.odb.type(obj)) {
        case 'simple':
          return this.cloneSimple(obj);

        case 'object':
          return this.cloneObject(obj);

        case 'list':
          return this.cloneList(obj);

        case 'function':
          return this.cloneFunction(obj);
      }
    },
    cloneFunction: function cloneFunction(func) {
      return func;
    },
    cloneSimple: function cloneSimple(obj) {
      return obj;
    },
    cloneObject: function cloneObject(obj) {
      if (obj === null) {
        return null;
      }

      if (obj.meta && typeof obj.meta.clone !== 'undefined' && !obj.meta.clone) {
        return obj;
      }

      var admin = this.odb.getObjectAdminData(obj);
      var clonedObj = this.cloneMap[admin.id];

      if (clonedObj) {
        return clonedObj;
      }

      clonedObj = this.cloneMap[admin.id] = this.odb.create('object', admin.name);

      for (var key in obj) {
        var value = obj[key];

        if (!obj.hasOwnProperty(key)) {
          continue;
        }

        if (this.odb.ignoreProperty(key)) {
          continue;
        }

        clonedObj[key] = this.clone(value);
      }

      return clonedObj;
    },
    cloneList: function cloneList(list) {
      var admin = this.odb.getObjectAdminData(list);
      var clonedList = this.cloneMap[admin.id];

      if (clonedList) {
        return clonedList;
      }

      clonedList = this.odb.create('list');
      this.cloneMap[admin.id] = clonedList;

      for (var i = 0; i < list.length; ++i) {
        var element = list[i];
        clonedList.push(this.clone(element));
      }

      return clonedList;
    }
  }; // =======================================================================
  // test
  // =======================================================================

  var test = function test() {
    class Label {
      constructor(label) {
        this.label = label;
      }

      getLabelText() {
        return this.label;
      }

    }

    Label.prototype.meta = {
      name: 'Label'
    };
    var odb = new Odb();
    var obj = {
      items: [{
        label: new Label('a')
      }, {
        label: new Label('b')
      }]
    };
    obj.ref = obj.items[1];
    var json = odb.toJson(obj);
    console.log(json);
    var dObj = odb.fromJson(json);
    console.log(dObj);
  };

  window.Odb = Odb;
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb3JlL09kYi5qcyJdLCJuYW1lcyI6WyJPZGIiLCJpbml0IiwiYXBwbHkiLCJhcmd1bWVudHMiLCJwcm90b3R5cGUiLCJjbHNNYXAiLCJtYXhJZCIsImdlbmVyYXRlSWQiLCJpc1JlZmVyZW5jZSIsInZhbHVlIiwiaWdub3JlUHJvcGVydHkiLCJwcm9wZXJ0eSIsInNsaWNlIiwidHlwZSIsIm9iaiIsIkFycmF5IiwiaXNBcnJheSIsImNyZWF0ZSIsIm5hbWUiLCJjbHMiLCJPYmplY3QiLCJnZXRPYmplY3RBZG1pbkRhdGEiLCJyZWdpc3RlckNsYXNzIiwiY29uc3RydWN0b3IiLCJtZXRhIiwiX19hZG1pbl9fIiwiaWQiLCJjbG9uZSIsImNsb25lciIsIkNsb25lciIsInRvSnNvbiIsInNlcmlhbGl6ZXIiLCJTZXJpYWxpemVyIiwiZnJvbUpzb24iLCJqc29uIiwiZGVTZXJpYWxpemVyIiwiRGVTZXJpYWxpemVyIiwib2RiIiwicHJvY2Vzc09iamVjdHMiLCJvYmplY3RzIiwianNvbk9iaiIsIm9iamVjdCIsImkiLCJsZW5ndGgiLCJlbGVtZW50IiwicHVzaCIsInByb2Nlc3NSZWxhdGlvbnMiLCJyZWZPYmpJZCIsInBvc3RQcm9jZXNzT2JqZWN0cyIsInBvc3REZVNlcmlhbGl6ZSIsInJvb3RJZCIsImlnbm9yZSIsIl90b0pzb24iLCJfcHV0SnNvbiIsIl9nZXRKc29uIiwiX3RvSnNvbk9iamVjdCIsIl90b0pzb25MaXN0Iiwic2VyaWFsaXplIiwidW5kZWZpbmVkIiwiYWRtaW4iLCJrZXkiLCJoYXNPd25Qcm9wZXJ0eSIsInJlZmVyZW5jZUlkIiwiY2xvbmVNYXAiLCJjbG9uZVNpbXBsZSIsImNsb25lT2JqZWN0IiwiY2xvbmVMaXN0IiwiY2xvbmVGdW5jdGlvbiIsImZ1bmMiLCJjbG9uZWRPYmoiLCJsaXN0IiwiY2xvbmVkTGlzdCIsInRlc3QiLCJMYWJlbCIsImxhYmVsIiwiZ2V0TGFiZWxUZXh0IiwiaXRlbXMiLCJyZWYiLCJj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PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIC8vIG9kYlxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbiAgICB2YXIgT2RiID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB0aGlzLmluaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICB9XG5cbiAgICBPZGIucHJvdG90eXBlID0ge1xuICAgICAgICBpbml0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB0aGlzLmNsc01hcCA9IHt9O1xuICAgICAgICAgICAgdGhpcy5tYXhJZCA9IDA7XG4gICAgICAgIH0sXG4gICAgICAgIGdlbmVyYXRlSWQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiAnIycgKyAoKyt0aGlzLm1heElkKVxuICAgICAgICB9LFxuICAgICAgICBpc1JlZmVyZW5jZTogZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAgICAgICByZXR1cm4gdmFsdWUgJiYgdmFsdWVbMF0gPT09ICcjJztcbiAgICAgICAgfSxcbiAgICAgICAgaWdub3JlUHJvcGVydHk6IGZ1bmN0aW9uIChwcm9wZXJ0eSkge1xuICAgICAgICAgICAgcmV0dXJuIHByb3BlcnR5ID09PSAnX19hZG1pbl9fJyB8fCBwcm9wZXJ0eS5zbGljZSgwLCAyKSA9PT0gJ19fJztcbiAgICAgICAgfSxcbiAgICAgICAgdHlwZTogZnVuY3Rpb24gKG9iaikge1xuICAgICAgICAgICAgc3dpdGNoICh0eXBlb2Ygb2JqKSB7XG4gICAgICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzpcbiAgICAgICAgICAgICAgICBjYXNlICdudW1iZXInOlxuICAgICAgICAgICAgICAgIGNhc2UgJ2Jvb2xlYW4nOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3NpbXBsZSc7XG4gICAgICAgICAgICAgICAgY2FzZSAnZnVuY3Rpb24nOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ2Z1bmN0aW9uJ1xuICAgICAgICAgICAgICAgIGNhc2UgJ29iamVjdCc6XG4gICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KG9iaikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnbGlzdCc7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ29iamVjdCc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgY3JlYXRlOiBmdW5jdGlvbiAodHlwZSwgbmFtZSkge1xuICAgICAgICAgICAgdmFyIG9iajtcbiAgICAgICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgICAgICAgIGNhc2UgJ29iamVjdCc6XG4gICAgICAgICAgICAgICAgICAgIGlmICghbmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb2JqID0ge31cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNscyA9IHRoaXMuY2xzTWFwW25hbWVdXG4gICAgICAgICAgICAgICAgICAgICAgICBvYmogPSBPYmplY3QuY3JlYXRlKGNscy5wcm90b3R5cGUpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSAnbGlzdCc6XG4gICAgICAgICAgICAgICAgICAgIG9iaiA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICB0aHJvdyAnaWxsZWdhbCB0eXBlJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZ2V0T2JqZWN0QWRtaW5EYXRhKG9iailcbiAgICAgICAgICAgIHJldHVybiBvYmpcbiAgICAgICAgfSxcbiAgICAgICAgcmVnaXN0ZXJDbGFzczogZnVuY3Rpb24gKGNvbnN0cnVjdG9yKSB7XG4gICAgICAgICAgICB0aGlzLmNsc01hcFtjb25zdHJ1Y3Rvci5wcm90b3R5cGUubWV0YS5uYW1lXSA9IGNvbnN0cnVjdG9yO1xuICAgICAgICB9LFxuICAgICAgICBnZXRPYmplY3RBZG1pbkRhdGE6IGZ1bmN0aW9uIChvYmopIHtcbiAgICAgICAgICAgIHZhciBuYW1lID0gb2JqLm1ldGEgJiYgb2JqLm1ldGEubmFtZTtcbiAgICAgICAgICAgIGlmIChuYW1lKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jbHNNYXBbbmFtZV0gPSBvYmouY29uc3RydWN0b3JcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBpZiAoIW9iai5fX2FkbWluX18pIHtcbiAgICAgICAgICAgICAgICBvYmouX19hZG1pbl9fID0ge1xuICAgICAgICAgICAgICAgICAgICBpZDogdGhpcy5nZW5lcmF0ZUlkKCksXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWVcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG9iai5fX2FkbWluX19cbiAgICAgICAgfSxcbiAgICAgICAgY2xvbmU6IGZ1bmN0aW9uIChvYmopIHtcbiAgICAgICAgICAgIHZhciBjbG9uZXIgPSBuZXcgQ2xvbmVyKHRoaXMpXG4gICAgICAgICAgICByZXR1cm4gY2xvbmVyLmNsb25lKG9iailcbiAgICAgICAgfSxcbiAgICAgICAgdG9Kc29uOiBmdW5jdGlvbiAob2JqKSB7XG4gICAgICAgICAgICB2YXIgc2VyaWFsaXplciA9IG5ldyBTZXJpYWxpemVyKHRoaXMpO1xuICAgICAgICAgICAgcmV0dXJuIHNlcmlhbGl6ZXIudG9Kc29uKG9iaik7XG4gICAgICAgIH0sXG4gICAgICAgIGZyb21Kc29uOiBmdW5jdGlvbiAoanNvbikge1xuICAgICAgICAgICAgdmFyIGRlU2VyaWFsaXplciA9IG5ldyBEZVNlcmlhbGl6ZXIodGhpcyk7XG4gICAgICAgICAgICByZXR1cm4gZGVTZXJpYWxpemVyLmZyb21Kc29uKGpzb24pO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgLy8gZGUtc2VyaWFsaXplclxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbiAgICB2YXIgRGVTZXJpYWxpemVyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB0aGlzLmluaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICB9XG5cbiAgICBEZVNlcmlhbGl6ZXIucHJvdG90eXBlID0ge1xuICAgICAgICBpbml0OiBmdW5jdGlvbiAob2RiKSB7XG4gICAgICAgICAgICB0aGlzLm9kYiA9IG9kYjtcbiAgICAgICAgfSxcbiAgICAgICAgcHJvY2Vzc09iamVjdHM6IGZ1bmN0aW9uIChqc29uKSB7XG4gICAgICAgICAgICB2YXIgb2JqZWN0cyA9IHt9O1xuICAgICAgICAgICAgZm9yICh2YXIgaWQgaW4ganNvbi5vYmplY3RzKSB7XG4gICAgICAgICAgICAgICAgdmFyIGpzb25PYmogPSBqc29uLm9iamVjdHNbaWRdO1xuICAgICAgICAgICAgICAgIHZhciBvYmplY3Q7XG4gICAgICAgICAgICAgICAgc3dpdGNoICh0aGlzLm9kYi50eXBlKGpzb25PYmopKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ29iamVjdCc6XG4gICAgICAgICAgICAgICAgICAgICAgICBvYmplY3QgPSB0aGlzLm9kYi5jcmVhdGUoJ29iamVjdCcsIGpzb25PYmouX19hZG1pbl9fLm5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgcHJvcGVydHkgaW4ganNvbk9iaikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm9kYi5pZ25vcmVQcm9wZXJ0eShwcm9wZXJ0eSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdFtwcm9wZXJ0eV0gPSBqc29uT2JqW3Byb3BlcnR5XTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBjYXNlICdsaXN0JzpcbiAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdCA9IHRoaXMub2RiLmNyZWF0ZSgnbGlzdCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBqc29uT2JqLmxlbmd0aDsgKytpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBqc29uT2JqW2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdC5wdXNoKGVsZW1lbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAnaWxsZWdhbCB0eXBlJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgb2JqZWN0c1tpZF0gPSBvYmplY3Q7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gb2JqZWN0cztcbiAgICAgICAgfSxcbiAgICAgICAgcHJvY2Vzc1JlbGF0aW9uczogZnVuY3Rpb24gKGpzb24sIG9iamVjdHMpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGlkIGluIG9iamVjdHMpIHtcbiAgICAgICAgICAgICAgICBvYmplY3QgPSBvYmplY3RzW2lkXTtcbiAgICAgICAgICAgICAgICB2YXIgcmVmT2JqSWQ7XG4gICAgICAgICAgICAgICAgc3dpdGNoICh0aGlzLm9kYi50eXBlKG9iamVjdCkpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnb2JqZWN0JzpcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIHByb3BlcnR5IGluIG9iamVjdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm9kYi5pZ25vcmVQcm9wZXJ0eShwcm9wZXJ0eSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZk9iaklkID0gb2JqZWN0W3Byb3BlcnR5XTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vZGIuaXNSZWZlcmVuY2UocmVmT2JqSWQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdFtwcm9wZXJ0eV0gPSBvYmplY3RzW3JlZk9iaklkXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnbGlzdCc6XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgb2JqZWN0Lmxlbmd0aDsgKytpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmT2JqSWQgPSBvYmplY3RbaV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub2RiLmlzUmVmZXJlbmNlKHJlZk9iaklkKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmplY3RbaV0gPSBvYmplY3RzW3JlZk9iaklkXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93ICdpbGxlZ2FsIHR5cGUnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgcG9zdFByb2Nlc3NPYmplY3RzOiBmdW5jdGlvbiAob2JqZWN0cykge1xuICAgICAgICAgICAgZm9yICh2YXIgaWQgaW4gb2JqZWN0cykge1xuICAgICAgICAgICAgICAgIHZhciBvYmplY3QgPSBvYmplY3RzW2lkXTtcbiAgICAgICAgICAgICAgICBpZiAob2JqZWN0LnBvc3REZVNlcmlhbGl6ZSkge1xuICAgICAgICAgICAgICAgICAgICBvYmplY3QucG9zdERlU2VyaWFsaXplKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBmcm9tSnNvbjogZnVuY3Rpb24gKGpzb24pIHtcbiAgICAgICAgICAgIC8vIG9iamVjdHNcbiAgICAgICAgICAgIHZhciBvYmplY3RzID0gdGhpcy5wcm9jZXNzT2JqZWN0cyhqc29uKTtcbiAgICAgICAgICAgIC8vIHJlbGF0aW9uc1xuICAgICAgICAgICAgdGhpcy5wcm9jZXNzUmVsYXRpb25zKGpzb24sIG9iamVjdHMpO1xuICAgICAgICAgICAgLy8gcG9zdCBwcm9jZXNzIG9iamVjdHNcbiAgICAgICAgICAgIHRoaXMucG9zdFByb2Nlc3NPYmplY3RzKG9iamVjdHMpO1xuICAgICAgICAgICAgLy8gcmV0dXJuIHJvb3Qgb2JqZWN0XG4gICAgICAgICAgICByZXR1cm4gb2JqZWN0c1tqc29uLnJvb3RJZF07XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAvLyBzZXJpYWxpemVyXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICAgIHZhciBpZ25vcmUgPSB7fTtcblxuICAgIHZhciBTZXJpYWxpemVyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB0aGlzLmluaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICB9XG5cbiAgICBTZXJpYWxpemVyLnByb3RvdHlwZSA9IHtcbiAgICAgICAgaW5pdDogZnVuY3Rpb24gKG9kYikge1xuICAgICAgICAgICAgdGhpcy5vZGIgPSBvZGI7XG4gICAgICAgICAgICB0aGlzLmpzb24gPSB7XG4gICAgICAgICAgICAgICAgcm9vdElkOiBudWxsLFxuICAgICAgICAgICAgICAgIG9iamVjdHM6IHt9XG4gICAgICAgICAgICB9O1xuICAgICAgICB9LFxuICAgICAgICB0b0pzb246IGZ1bmN0aW9uIChvYmopIHtcbiAgICAgICAgICAgIHRoaXMuX3RvSnNvbihvYmopO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuanNvbjtcbiAgICAgICAgfSxcbiAgICAgICAgX3B1dEpzb246IGZ1bmN0aW9uIChvYmopIHtcbiAgICAgICAgICAgIHRoaXMuanNvbi5vYmplY3RzW29iai5fX2FkbWluX18uaWRdID0gb2JqO1xuICAgICAgICAgICAgaWYgKCF0aGlzLmpzb24ucm9vdElkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5qc29uLnJvb3RJZCA9IG9iai5fX2FkbWluX18uaWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIF9nZXRKc29uOiBmdW5jdGlvbiAoaWQpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmpzb24ub2JqZWN0c1tpZF07XG4gICAgICAgIH0sXG4gICAgICAgIF90b0pzb246IGZ1bmN0aW9uIChvYmopIHtcbiAgICAgICAgICAgIHN3aXRjaCAodGhpcy5vZGIudHlwZShvYmopKSB7XG4gICAgICAgICAgICAgICAgY2FzZSAnc2ltcGxlJzpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9iajtcbiAgICAgICAgICAgICAgICBjYXNlICdvYmplY3QnOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fdG9Kc29uT2JqZWN0KG9iaik7XG4gICAgICAgICAgICAgICAgY2FzZSAnbGlzdCc6XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl90b0pzb25MaXN0KG9iaik7XG4gICAgICAgICAgICAgICAgY2FzZSAnZnVuY3Rpb24nOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWdub3JlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBfdG9Kc29uT2JqZWN0OiBmdW5jdGlvbiAob2JqKSB7XG4gICAgICAgICAgICBpZiAob2JqID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAob2JqLm1ldGEgJiYgb2JqLm1ldGEuc2VyaWFsaXplICE9PSB1bmRlZmluZWQgJiYgIW9iai5tZXRhLnNlcmlhbGl6ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBpZ25vcmU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgYWRtaW4gPSB0aGlzLm9kYi5nZXRPYmplY3RBZG1pbkRhdGEob2JqKTtcbiAgICAgICAgICAgIHZhciBqc29uT2JqID0gdGhpcy5fZ2V0SnNvbihhZG1pbi5pZCk7XG4gICAgICAgICAgICBpZiAoanNvbk9iaikge1xuICAgICAgICAgICAgICAgIHJldHVybiBqc29uT2JqLl9fYWRtaW5fXy5pZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBqc29uT2JqID0ge307XG4gICAgICAgICAgICBqc29uT2JqLl9fYWRtaW5fXyA9IG9iai5fX2FkbWluX187XG4gICAgICAgICAgICB0aGlzLl9wdXRKc29uKGpzb25PYmopO1xuICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIG9iaikge1xuICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IG9ialtrZXldO1xuICAgICAgICAgICAgICAgIGlmICghb2JqLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0aGlzLm9kYi5pZ25vcmVQcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgcmVmZXJlbmNlSWQgPSB0aGlzLl90b0pzb24odmFsdWUpO1xuICAgICAgICAgICAgICAgIGlmIChyZWZlcmVuY2VJZCA9PT0gaWdub3JlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBqc29uT2JqW2tleV0gPSByZWZlcmVuY2VJZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBqc29uT2JqLl9fYWRtaW5fXy5pZDtcbiAgICAgICAgfSxcbiAgICAgICAgX3RvSnNvbkxpc3Q6IGZ1bmN0aW9uIChvYmopIHtcbiAgICAgICAgICAgIGlmIChvYmoubWV0YSAmJiBvYmoubWV0YS5zZXJpYWxpemUgIT09IHVuZGVmaW5lZCAmJiAhb2JqLm1ldGEuc2VyaWFsaXplKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGlnbm9yZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBhZG1pbiA9IHRoaXMub2RiLmdldE9iamVjdEFkbWluRGF0YShvYmopO1xuICAgICAgICAgICAgdmFyIGpzb25PYmogPSB0aGlzLl9nZXRKc29uKGFkbWluLmlkKTtcbiAgICAgICAgICAgIGlmIChqc29uT2JqKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGpzb25PYmouX19hZG1pbl9fLmlkO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAganNvbk9iaiA9IFtdO1xuICAgICAgICAgICAganNvbk9iai5fX2FkbWluX18gPSBvYmouX19hZG1pbl9fO1xuICAgICAgICAgICAgdGhpcy5fcHV0SnNvbihqc29uT2JqKTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmxlbmd0aDsgKytpKSB7XG4gICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gb2JqW2ldO1xuICAgICAgICAgICAgICAgIHZhciByZWZlcmVuY2VJZCA9IHRoaXMuX3RvSnNvbih2YWx1ZSk7XG4gICAgICAgICAgICAgICAgaWYgKHJlZmVyZW5jZUlkID09PSBpZ25vcmUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGpzb25PYmoucHVzaChyZWZlcmVuY2VJZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4ganNvbk9iai5fX2FkbWluX18uaWQ7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAvLyBjbG9uZXJcbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gICAgdmFyIENsb25lciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdGhpcy5pbml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgfVxuXG4gICAgQ2xvbmVyLnByb3RvdHlwZSA9IHtcbiAgICAgICAgaW5pdDogZnVuY3Rpb24gKG9kYikge1xuICAgICAgICAgICAgdGhpcy5vZGIgPSBvZGJcbiAgICAgICAgICAgIHRoaXMuY2xvbmVNYXAgPSB7fVxuICAgICAgICB9LFxuICAgICAgICBjbG9uZTogZnVuY3Rpb24gKG9iaikge1xuICAgICAgICAgICAgc3dpdGNoICh0aGlzLm9kYi50eXBlKG9iaikpIHtcbiAgICAgICAgICAgICAgICBjYXNlICdzaW1wbGUnOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jbG9uZVNpbXBsZShvYmopO1xuICAgICAgICAgICAgICAgIGNhc2UgJ29iamVjdCc6XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNsb25lT2JqZWN0KG9iailcbiAgICAgICAgICAgICAgICBjYXNlICdsaXN0JzpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2xvbmVMaXN0KG9iailcbiAgICAgICAgICAgICAgICBjYXNlICdmdW5jdGlvbic6XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNsb25lRnVuY3Rpb24ob2JqKVxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBjbG9uZUZ1bmN0aW9uOiBmdW5jdGlvbiAoZnVuYykgeyByZXR1cm4gZnVuYzsgfSxcbiAgICAgICAgY2xvbmVTaW1wbGU6IGZ1bmN0aW9uIChvYmopIHsgcmV0dXJuIG9iajsgfSxcbiAgICAgICAgY2xvbmVPYmplY3Q6IGZ1bmN0aW9uIChvYmopIHtcbiAgICAgICAgICAgIGlmIChvYmogPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChvYmoubWV0YSAmJiB0eXBlb2Ygb2JqLm1ldGEuY2xvbmUgIT09ICd1bmRlZmluZWQnICYmICFvYmoubWV0YS5jbG9uZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBvYmo7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgYWRtaW4gPSB0aGlzLm9kYi5nZXRPYmplY3RBZG1pbkRhdGEob2JqKTtcbiAgICAgICAgICAgIHZhciBjbG9uZWRPYmogPSB0aGlzLmNsb25lTWFwW2FkbWluLmlkXTtcbiAgICAgICAgICAgIGlmIChjbG9uZWRPYmopIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gY2xvbmVkT2JqO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2xvbmVkT2JqID0gdGhpcy5jbG9uZU1hcFthZG1pbi5pZF0gPSB0aGlzLm9kYi5jcmVhdGUoJ29iamVjdCcsIGFkbWluLm5hbWUpXG4gICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7XG4gICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gb2JqW2tleV07XG4gICAgICAgICAgICAgICAgaWYgKCFvYmouaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMub2RiLmlnbm9yZVByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNsb25lZE9ialtrZXldID0gdGhpcy5jbG9uZSh2YWx1ZSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBjbG9uZWRPYmo7XG4gICAgICAgIH0sXG4gICAgICAgIGNsb25lTGlzdDogZnVuY3Rpb24gKGxpc3QpIHtcbiAgICAgICAgICAgIHZhciBhZG1pbiA9IHRoaXMub2RiLmdldE9iamVjdEFkbWluRGF0YShsaXN0KVxuICAgICAgICAgICAgdmFyIGNsb25lZExpc3QgPSB0aGlzLmNsb25lTWFwW2FkbWluLmlkXTtcbiAgICAgICAgICAgIGlmIChjbG9uZWRMaXN0KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNsb25lZExpc3Q7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjbG9uZWRMaXN0ID0gdGhpcy5vZGIuY3JlYXRlKCdsaXN0Jyk7XG4gICAgICAgICAgICB0aGlzLmNsb25lTWFwW2FkbWluLmlkXSA9IGNsb25lZExpc3Q7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IGxpc3RbaV07XG4gICAgICAgICAgICAgICAgY2xvbmVkTGlzdC5wdXNoKHRoaXMuY2xvbmUoZWxlbWVudCkpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gY2xvbmVkTGlzdDtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIC8vIHRlc3RcbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gICAgdmFyIHRlc3QgPSBmdW5jdGlvbiAoKSB7XG5cbiAgICAgICAgY2xhc3MgTGFiZWwge1xuICAgICAgICAgICAgY29uc3RydWN0b3IobGFiZWwpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxhYmVsID0gbGFiZWxcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGdldExhYmVsVGV4dCgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sYWJlbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBMYWJlbC5wcm90b3R5cGUubWV0YSA9IHsgbmFtZTogJ0xhYmVsJyB9O1xuXG4gICAgICAgIHZhciBvZGIgPSBuZXcgT2RiKCk7XG5cbiAgICAgICAgdmFyIG9iaiA9IHtcbiAgICAgICAgICAgIGl0ZW1zOiBbe1xuICAgICAgICAgICAgICAgIGxhYmVsOiBuZXcgTGFiZWwoJ2EnKVxuICAgICAgICAgICAgfSwge1xuICAgICAgICAgICAgICAgIGxhYmVsOiBuZXcgTGFiZWwoJ2InKVxuICAgICAgICAgICAgfV1cbiAgICAgICAgfTtcbiAgICAgICAgb2JqLnJlZiA9IG9iai5pdGVtc1sxXTtcblxuICAgICAgICB2YXIganNvbiA9IG9kYi50b0pzb24ob2JqKTtcbiAgICAgICAgY29uc29sZS5sb2coanNvbik7XG4gICAgICAgIHZhciBkT2JqID0gb2RiLmZyb21Kc29uKGpzb24pO1xuICAgICAgICBjb25zb2xlLmxvZyhkT2JqKTtcblxuICAgIH1cblxuICAgIHdpbmRvdy5PZGIgPSBPZGI7XG59KSgpOyJdfQ==