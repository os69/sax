"use strict";

define(['../../core/core', './PropertyCollector', '../../core/event', '../util', './Property'], function (core, PropertyCollector, event, util, Property) {
  return core.defineDerivedClass(Property, {
    init: function init(params) {
      Property.prototype.init.apply(this, [params]);
      this.calc = params.calc;
      this.callback = params.callback;
      this.dependencies = [];

      if (params.start) {
        this.start();
      }
    },
    start: function start() {
      if (this.active) {
        return;
      }

      this.active = true;
      this.calculate();
    },
    stop: function stop() {
      if (!this.active) {
        return;
      }

      this.removeDependencyChangedEventHandlers();
      this.active = false;
    },
    calculate: function calculate() {
      var propertyCollector = PropertyCollector.create({
        addCallback: function (dependency) {
          event.addEventHandler(dependency.obj, util.methodName('set', dependency.propertyName), this, this.calculate);
        }.bind(this)
      });
      var value = this.calc();
      var dependencies = propertyCollector.stop();
      this.updateDependencyChangedEventHandlers(dependencies);
      this.callback(value);
    },
    updateDependencyChangedEventHandlers: function updateDependencyChangedEventHandlers(dependencies) {
      // helper
      var hasProperty = function hasProperty(properties, property) {
        for (var i = 0; i < properties.length; ++i) {
          var checkProperty = properties[i];

          if (checkProperty.obj === property.obj && checkProperty.propertyName === property.propertyName) {
            return true;
          }
        }

        return false;
      }; // calculate new dependencies


      var i, dependency;

      for (i = 0; i < dependencies.length; ++i) {
        dependency = dependencies[i];

        if (!hasProperty(this.dependencies, dependency)) {
          this.dependencies.push(dependency); //event.addEventHandler(dependency.obj, util.methodName('set', dependency.propertyName), this, this.calculate); --> add callback
        }
      } // calculate deleted dependencies


      for (i = 0; i < this.dependencies.length; ++i) {
        dependency = this.dependencies[i];

        if (!hasProperty(dependencies, dependency)) {
          event.removeEventHandler(dependency.obj, util.methodName('set', dependency.propertyName), this, this.calculate);
          this.dependencies.splice(i, 1);
          --i;
        }
      }
    },
    removeDependencyChangedEventHandlers: function removeDependencyChangedEventHandlers() {
      for (var i = 0; i < this.dependencies.length; ++i) {
        var dependency = this.dependencies[i];
        event.removeEventHandler(dependency.obj, util.methodName('set', dependency.propertyName), this, this.calculate);
      }

      this.dependencies = [];
    }
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy90dC9wcm9wZXJ0eS9DYWxjdWxhdGVkUHJvcGVydHkuanMiXSwibmFtZXMiOlsiZGVmaW5lIiwiY29yZSIsIlByb3BlcnR5Q29sbGVjdG9yIiwiZXZlbnQiLCJ1dGlsIiwiUHJvcGVydHkiLCJkZWZpbmVEZXJpdmVkQ2xhc3MiLCJpbml0IiwicGFyYW1zIiwicHJvdG90eXBlIiwiYXBwbHkiLCJjYWxjIiwiY2FsbGJhY2siLCJkZXBlbmRlbmNpZXMiLCJzdGFydCIsImFjdGl2ZSIsImNhbGN1bGF0ZSIsInN0b3AiLCJyZW1vdmVEZXBlbmRlbmN5Q2hhbmdlZEV2ZW50SGFuZGxlcnMiLCJwcm9wZXJ0eUNvbGxlY3RvciIsImNyZWF0ZSIsImFkZENhbGxiYWNrIiwiZGVwZW5kZW5jeSIsImFkZEV2ZW50SGFuZGxlciIsIm9iaiIsIm1ldGhvZE5hbWUiLCJwcm9wZXJ0eU5hbWUiLCJiaW5kIiwidmFsdWUiLCJ1cGRhdGVEZXBlbmRlbmN5Q2hhbmdlZEV2ZW50SGFuZGxlcnMiLCJoYXNQcm9wZXJ0eSIsInByb3BlcnRpZXMiLCJwcm9wZXJ0eSIsImkiLCJsZW5ndGgiLCJjaGVja1Byb3BlcnR5IiwicHVzaCIsInJlbW92ZUV2ZW50SGFuZGxlciIsInNwbGljZSJdLCJtYXBwaW5ncyI6Ijs7QUFBQUEsTUFBTSxDQUFDLENBQUMsaUJBQUQsRUFBb0IscUJBQXBCLEVBQTJDLGtCQUEzQyxFQUErRCxTQUEvRCxFQUEwRSxZQUExRSxDQUFELEVBQTBGLFVBQVVDLElBQVYsRUFBZ0JDLGlCQUFoQixFQUFtQ0MsS0FBbkMsRUFBMENDLElBQTFDLEVBQWdEQyxRQUFoRCxFQUEwRDtBQUV0SixTQUFPSixJQUFJLENBQUNLLGtCQUFMLENBQXdCRCxRQUF4QixFQUFrQztBQUNyQ0UsSUFBQUEsSUFBSSxFQUFFLGNBQVVDLE1BQVYsRUFBa0I7QUFDcEJILE1BQUFBLFFBQVEsQ0FBQ0ksU0FBVCxDQUFtQkYsSUFBbkIsQ0FBd0JHLEtBQXhCLENBQThC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Q0FBYjs7QUFDQSxZQUFJLENBQUNILFdBQVcsQ0FBQ2pCLFlBQUQsRUFBZVMsVUFBZixDQUFoQixFQUE0QztBQUN4Q25CLFVBQUFBLEtBQUssQ0FBQ2tDLGtCQUFOLENBQXlCZixVQUFVLENBQUNFLEdBQXBDLEVBQXlDcEIsSUFBSSxDQUFDcUIsVUFBTCxDQUFnQixLQUFoQixFQUF1QkgsVUFBVSxDQUFDSSxZQUFsQyxDQUF6QyxFQUEwRixJQUExRixFQUFnRyxLQUFLVixTQUFyRztBQUNBLGVBQUtILFlBQUwsQ0FBa0J5QixNQUFsQixDQUF5QkwsQ0FBekIsRUFBNEIsQ0FBNUI7QUFDQSxZQUFFQSxDQUFGO0FBQ0g7QUFDSjtBQUNKLEtBaEVvQztBQWlFckNmLElBQUFBLG9DQUFvQyxFQUFFLGdEQUFZO0FBQzlDLFdBQUssSUFBSWUsQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBRyxLQUFLcEIsWUFBTCxDQUFrQnFCLE1BQXRDLEVBQThDLEVBQUVELENBQWhELEVBQW1EO0FBQy9DLFlBQUlYLFVBQVUsR0FBRyxLQUFLVCxZQUFMLENBQWtCb0IsQ0FBbEIsQ0FBakI7QUFDQTlCLFFBQUFBLEtBQUssQ0FBQ2tDLGtCQUFOLENBQXlCZixVQUFVLENBQUNFLEdBQXBDLEVBQXlDcEIsSUFBSSxDQUFDcUIsVUFBTCxDQUFnQixLQUFoQixFQUF1QkgsVUFBVSxDQUFDSSxZQUFsQyxDQUF6QyxFQUEwRixJQUExRixFQUFnRyxLQUFLVixTQUFyRztBQUNIOztBQUNELFdBQUtILFlBQUwsR0FBb0IsRUFBcEI7QUFDSDtBQXZFb0MsR0FBbEMsQ0FBUDtBQTBFSCxDQTVFSyxDQUFOIiwic291cmNlc0NvbnRlbnQiOlsiZGVmaW5lKFsnLi4vLi4vY29yZS9jb3JlJywgJy4vUHJvcGVydHlDb2xsZWN0b3InLCAnLi4vLi4vY29yZS9ldmVudCcsICcuLi91dGlsJywgJy4vUHJvcGVydHknXSwgZnVuY3Rpb24gKGNvcmUsIFByb3BlcnR5Q29sbGVjdG9yLCBldmVudCwgdXRpbCwgUHJvcGVydHkpIHtcblxuICAgIHJldHVybiBjb3JlLmRlZmluZURlcml2ZWRDbGFzcyhQcm9wZXJ0eSwge1xuICAgICAgICBpbml0OiBmdW5jdGlvbiAocGFyYW1zKSB7XG4gICAgICAgICAgICBQcm9wZXJ0eS5wcm90b3R5cGUuaW5pdC5hcHBseSh0aGlzLCBbcGFyYW1zXSk7XG4gICAgICAgICAgICB0aGlzLmNhbGMgPSBwYXJhbXMuY2FsYztcbiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2sgPSBwYXJhbXMuY2FsbGJhY2s7XG4gICAgICAgICAgICB0aGlzLmRlcGVuZGVuY2llcyA9IFtdO1xuICAgICAgICAgICAgaWYgKHBhcmFtcy5zdGFydCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhcnQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuYWN0aXZlID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuY2FsY3VsYXRlKCk7XG4gICAgICAgIH0sXG4gICAgICAgIHN0b3A6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5hY3RpdmUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnJlbW92ZURlcGVuZGVuY3lDaGFuZ2VkRXZlbnRIYW5kbGVycygpO1xuICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTtcbiAgICAgICAgfSxcbiAgICAgICAgY2FsY3VsYXRlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgcHJvcGVydHlDb2xsZWN0b3IgPSBQcm9wZXJ0eUNvbGxlY3Rvci5jcmVhdGUoe1xuICAgICAgICAgICAgICAgIGFkZENhbGxiYWNrOiBmdW5jdGlvbiAoZGVwZW5kZW5jeSkge1xuICAgICAgICAgICAgICAgICAgICBldmVudC5hZGRFdmVudEhhbmRsZXIoZGVwZW5kZW5jeS5vYmosIHV0aWwubWV0aG9kTmFtZSgnc2V0JywgZGVwZW5kZW5jeS5wcm9wZXJ0eU5hbWUpLCB0aGlzLCB0aGlzLmNhbGN1bGF0ZSk7XG4gICAgICAgICAgICAgICAgfS5iaW5kKHRoaXMpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuY2FsYygpO1xuICAgICAgICAgICAgdmFyIGRlcGVuZGVuY2llcyA9IHByb3BlcnR5Q29sbGVjdG9yLnN0b3AoKTtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlRGVwZW5kZW5jeUNoYW5nZWRFdmVudEhhbmRsZXJzKGRlcGVuZGVuY2llcyk7XG4gICAgICAgICAgICB0aGlzLmNhbGxiYWNrKHZhbHVlKTtcbiAgICAgICAgfSxcbiAgICAgICAgdXBkYXRlRGVwZW5kZW5jeUNoYW5nZWRFdmVudEhhbmRsZXJzOiBmdW5jdGlvbiAoZGVwZW5kZW5jaWVzKSB7XG4gICAgICAgICAgICAvLyBoZWxwZXJcbiAgICAgICAgICAgIHZhciBoYXNQcm9wZXJ0eSA9IGZ1bmN0aW9uIChwcm9wZXJ0aWVzLCBwcm9wZXJ0eSkge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcGVydGllcy5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgY2hlY2tQcm9wZXJ0eSA9IHByb3BlcnRpZXNbaV07XG4gICAgICAgICAgICAgICAgICAgIGlmIChjaGVja1Byb3BlcnR5Lm9iaiA9PT0gcHJvcGVydHkub2JqICYmIGNoZWNrUHJvcGVydHkucHJvcGVydHlOYW1lID09PSBwcm9wZXJ0eS5wcm9wZXJ0eU5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIGNhbGN1bGF0ZSBuZXcgZGVwZW5kZW5jaWVzXG4gICAgICAgICAgICB2YXIgaSwgZGVwZW5kZW5jeTtcbiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBkZXBlbmRlbmNpZXMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgICAgICAgICBkZXBlbmRlbmN5ID0gZGVwZW5kZW5jaWVzW2ldO1xuICAgICAgICAgICAgICAgIGlmICghaGFzUHJvcGVydHkodGhpcy5kZXBlbmRlbmNpZXMsIGRlcGVuZGVuY3kpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGVwZW5kZW5jaWVzLnB1c2goZGVwZW5kZW5jeSk7XG4gICAgICAgICAgICAgICAgICAgIC8vZXZlbnQuYWRkRXZlbnRIYW5kbGVyKGRlcGVuZGVuY3kub2JqLCB1dGlsLm1ldGhvZE5hbWUoJ3NldCcsIGRlcGVuZGVuY3kucHJvcGVydHlOYW1lKSwgdGhpcywgdGhpcy5jYWxjdWxhdGUpOyAtLT4gYWRkIGNhbGxiYWNrXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gY2FsY3VsYXRlIGRlbGV0ZWQgZGVwZW5kZW5jaWVzXG4gICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5kZXBlbmRlbmNpZXMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgICAgICAgICBkZXBlbmRlbmN5ID0gdGhpcy5kZXBlbmRlbmNpZXNbaV07XG4gICAgICAgICAgICAgICAgaWYgKCFoYXNQcm9wZXJ0eShkZXBlbmRlbmNpZXMsIGRlcGVuZGVuY3kpKSB7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnJlbW92ZUV2ZW50SGFuZGxlcihkZXBlbmRlbmN5Lm9iaiwgdXRpbC5tZXRob2ROYW1lKCdzZXQnLCBkZXBlbmRlbmN5LnByb3BlcnR5TmFtZSksIHRoaXMsIHRoaXMuY2FsY3VsYXRlKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZXBlbmRlbmNpZXMuc3BsaWNlKGksIDEpO1xuICAgICAgICAgICAgICAgICAgICAtLWk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICByZW1vdmVEZXBlbmRlbmN5Q2hhbmdlZEV2ZW50SGFuZGxlcnM6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5kZXBlbmRlbmNpZXMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgICAgICAgICB2YXIgZGVwZW5kZW5jeSA9IHRoaXMuZGVwZW5kZW5jaWVzW2ldO1xuICAgICAgICAgICAgICAgIGV2ZW50LnJlbW92ZUV2ZW50SGFuZGxlcihkZXBlbmRlbmN5Lm9iaiwgdXRpbC5tZXRob2ROYW1lKCdzZXQnLCBkZXBlbmRlbmN5LnByb3BlcnR5TmFtZSksIHRoaXMsIHRoaXMuY2FsY3VsYXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZGVwZW5kZW5jaWVzID0gW107XG4gICAgICAgIH1cbiAgICB9KTtcblxufSk7XG5cbiJdfQ==