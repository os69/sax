"use strict";

define(['./core', './ObjectManager'], function (core, ObjectManager) {
  var module = {
    eventDataProperty: '__tt_event__',
    numHandlers: 0,
    getNumberHandlers: function getNumberHandlers() {
      return module.numHandlers;
    },
    addEventHandler: function addEventHandler(sender, signal, receiver, handler) {
      if (module._senderHasSignalReceiver(sender, signal, receiver)) {
        return;
      }

      module._notifyModificationHandlers('add', sender, signal, receiver, handler);

      var success1 = module._addEventSenderToReceiver(sender, signal, receiver, handler);

      var success2 = module._addEventReceiverToSender(sender, signal, receiver, handler);

      if (!success1 || !success2) {
        throw 'program error';
      }

      this.numHandlers++;
    },
    removeEventHandler: function removeEventHandler(sender, signal, receiver, handler) {
      if (!module._senderHasSignalReceiver(sender, signal, receiver)) {
        return;
      }

      module._notifyModificationHandlers('remove', sender, signal, receiver, handler);

      var success1 = module._removeEventSenderFromReceiver(sender, signal, receiver, handler);

      var success2 = module._removeEventReceiverFromSender(sender, signal, receiver, handler);

      if (!success1 || !success2) {
        throw 'program error';
      }

      this.numHandlers--;
    },
    delete: function _delete(obj) {
      var eventData = module.getEventData(obj); // collect event subscriptions where obj is sender

      var signal, receivers, receiverId, handlers, senders, senderId, i, handler, subscriptions;
      subscriptions = [];

      for (signal in eventData.receiversMap) {
        receivers = eventData.receiversMap[signal];

        for (receiverId in receivers) {
          handlers = receivers[receiverId];

          for (i = 0; i < handlers.length; ++i) {
            handler = handlers[i];
            subscriptions.push([obj, signal, eventData.receiverObjectManager.getObject(receiverId), handler]);
          }
        }
      } // collect event subscriptions  where obj is receiver


      for (signal in eventData.sendersMap) {
        senders = eventData.sendersMap[signal];

        for (senderId in senders) {
          handlers = senders[senderId];

          for (i = 0; i < handlers.length; ++i) {
            handler = handlers[i];
            subscriptions.push([eventData.senderObjectManager.getObject(senderId), signal, obj, handler]);
          }
        }
      } // remove subscriptions


      for (var i = 0; i < subscriptions.length; ++i) {
        var subscription = subscriptions[i];
        module.removeEventHandler.apply(module, subscription);
      }
    },
    raiseEvent: function raiseEvent(sender, signal, message) {
      var eventData = module.getEventData(sender);
      var receivers = eventData.receiversMap[signal];

      if (!receivers) {
        return;
      } // collect events


      var events = [];
      var receiverId, handler, handlers;

      for (receiverId in receivers) {
        handlers = receivers[receiverId];

        for (var i = 0; i < handlers.length; ++i) {
          handler = handlers[i];
          events.push([receiverId, handler]);
        }
      } // process events


      for (var j = 0; j < events.length; ++j) {
        var event = events[j];
        receiverId = event[0];
        handler = event[1];
        receivers = eventData.receiversMap[signal];

        if (!receivers) {
          return;
        }

        handlers = receivers[receiverId];

        if (!handlers) {
          continue;
        }

        if (!core.hasObject(handlers, handler)) {
          continue;
        }

        handler.apply(eventData.receiverObjectManager.getObject(receiverId), [signal, message]);
      }
    },
    addModificationHandler: function addModificationHandler(obj, modificationHandler) {
      var eventData = module.getEventData(obj);

      if (core.hasObject(eventData.modificationHandlers, modificationHandler)) {
        return;
      }

      eventData.modificationHandlers.push(modificationHandler);
    },
    _notifyModificationHandlers: function _notifyModificationHandlers(action, sender, signal, receiver, handler) {
      var notify = function notify(modificationHandlers) {
        for (var i = 0; i < modificationHandlers.length; ++i) {
          var modificationHandler = modificationHandlers[i];
          modificationHandler(action, sender, signal, receiver, handler);
        }
      };

      notify(module.getEventData(sender).modificationHandlers);
      notify(module.getEventData(receiver).modificationHandlers);
    },
    getEventData: function getEventData(obj) {
      var eventData = obj[this.eventDataProperty];

      if (eventData) {
        return eventData;
      }

      eventData = module._createEventData();
      obj[this.eventDataProperty] = eventData;
      return eventData;
    },
    _createEventData: function _createEventData() {
      var eventData = {};
      eventData.receiversMap = {}; // { signal : { receiverId : [handler]}}

      eventData.sendersMap = {}; // { signal : { senderId:  [handler]}}

      eventData.id = core.generateId();
      eventData.receiverObjectManager = new ObjectManager();
      eventData.senderObjectManager = new ObjectManager();
      eventData.modificationHandlers = [];
      return eventData;
    },
    _addEventReceiverToSender: function _addEventReceiverToSender(sender, signal, receiver, handler) {
      var senderEventData = module.getEventData(sender);
      var receiverEventData = module.getEventData(receiver);
      senderEventData.receiverObjectManager.registerObject(receiverEventData.id, receiver);
      var receivers = senderEventData.receiversMap[signal];

      if (!receivers) {
        senderEventData.receiversMap[signal] = receivers = {};
      }

      var handlers = receivers[receiverEventData.id];

      if (!handlers) {
        receivers[receiverEventData.id] = handlers = [];
      }

      if (core.hasObject(handlers, handler)) {
        return false;
      }

      handlers.push(handler);
      return true;
    },
    _removeEventReceiverFromSender: function _removeEventReceiverFromSender(sender, signal, receiver, handler) {
      var senderEventData = module.getEventData(sender);
      var receiverEventData = module.getEventData(receiver);
      var receivers = senderEventData.receiversMap[signal];

      if (!receivers) {
        return false;
      }

      var handlers = receivers[receiverEventData.id];

      if (!handlers) {
        return false;
      }

      var numDel = core.removeObject(handlers, handler);
      var success = numDel > 0;

      if (handlers.length === 0) {
        delete receivers[receiverEventData.id];

        if (!module._senderHasReceiver(sender, receiver)) {
          senderEventData.receiverObjectManager.deleteObject(receiverEventData.id);
        }
      }

      if (core.isEmpty(receivers)) {
        delete senderEventData.receiversMap[signal];
      }

      return success;
    },
    _senderHasReceiver: function _senderHasReceiver(sender, receiver) {
      var senderEventData = module.getEventData(sender);
      var receiverEventData = module.getEventData(receiver);

      for (var signal in senderEventData.receiversMap) {
        var receivers = senderEventData.receiversMap[signal];
        var handlers = receivers[receiverEventData.id];

        if (handlers) {
          return true;
        }
      }

      return false;
    },
    _senderHasSignalReceiver: function _senderHasSignalReceiver(sender, signal, receiver) {
      var senderEventData = module.getEventData(sender);
      var receiverEventData = module.getEventData(receiver);
      var receivers = senderEventData.receiversMap[signal];

      if (!receivers) {
        return false;
      }

      var handlers = receivers[receiverEventData.id];

      if (!handlers) {
        return false;
      }

      return true;
    },
    _receiverHasSender: function _receiverHasSender(receiver, sender) {
      var senderEventData = module.getEventData(sender);
      var receiverEventData = module.getEventData(receiver);

      for (var signal in receiverEventData.sendersMap) {
        var senders = receiverEventData.sendersMap[signal];
        var handlers = senders[senderEventData.id];

        if (handlers) {
          return true;
        }
      }

      return false;
    },
    _receiverHasSignalSender: function _receiverHasSignalSender(receiver, signal, sender) {
      var senderEventData = module.getEventData(sender);
      var receiverEventData = module.getEventData(receiver);
      var senders = receiverEventData.sendersMap[signal];

      if (!senders) {
        return false;
      }

      var handlers = senders[senderEventData.id];

      if (!handlers) {
        return false;
      }

      return false;
    },
    _addEventSenderToReceiver: function _addEventSenderToReceiver(sender, signal, receiver, handler) {
      var senderEventData = module.getEventData(sender);
      var receiverEventData = module.getEventData(receiver);
      receiverEventData.senderObjectManager.registerObject(senderEventData.id, sender);
      var senders = receiverEventData.sendersMap[signal];

      if (!senders) {
        receiverEventData.sendersMap[signal] = senders = {};
      }

      var handlers = senders[senderEventData.id];

      if (!handlers) {
        senders[senderEventData.id] = handlers = [];
      }

      if (core.hasObject(handlers, handler)) {
        return false;
      }

      handlers.push(handler);
      return true;
    },
    _removeEventSenderFromReceiver: function _removeEventSenderFromReceiver(sender, signal, receiver, handler) {
      var senderEventData = module.getEventData(sender);
      var receiverEventData = module.getEventData(receiver);
      var senders = receiverEventData.sendersMap[signal];

      if (!senders) {
        return false;
      }

      var handlers = senders[senderEventData.id];

      if (!handlers) {
        return false;
      }

      var numDel = core.removeObject(handlers, handler);
      var success = numDel > 0;

      if (handlers.length === 0) {
        delete senders[senderEventData.id];

        if (!module._receiverHasSender(receiver, sender)) {
          receiverEventData.senderObjectManager.deleteObject(senderEventData.id);
        }
      }

      if (core.isEmpty(senders)) {
        delete receiverEventData.sendersMap[signal];
      }

      return success;
    }
  };
  return module;
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb3JlL2V2ZW50LmpzIl0sIm5hbWVzIjpbImRlZmluZSIsImNvcmUiLCJPYmplY3RNYW5hZ2VyIiwibW9kdWxlIiwiZXZlbnREYXRhUHJvcGVydHkiLCJudW1IYW5kbGVycyIsImdldE51bWJlckhhbmRsZXJzIiwiYWRkRXZlbnRIYW5kbGVyIiwic2VuZGVyIiwic2lnbmFsIiwicmVjZWl2ZXIiLCJoYW5kbGVyIiwiX3NlbmRlckhhc1NpZ25hbFJlY2VpdmVyIiwiX25vdGlmeU1vZGlmaWNhdGlvbkhhbmRsZXJzIiwic3VjY2VzczEiLCJfYWRkRXZlbnRTZW5kZXJUb1JlY2VpdmVyIiwic3VjY2VzczIiLCJfYWRkRXZlbnRSZWNlaXZlclRvU2VuZGVyIiwicmVtb3ZlRXZlbnRIYW5kbGVyIiwiX3JlbW92ZUV2ZW50U2VuZGVyRnJvbVJlY2VpdmVyIiwiX3JlbW92ZUV2ZW50UmVjZWl2ZXJGcm9tU2VuZGVyIiwiZGVsZXRlIiwib2JqIiwiZXZlbnREYXRhIiwiZ2V0RXZlbnREYXRhIiwicmVjZWl2ZXJzIiwicmVjZWl2ZXJJZCIsImhhbmRsZXJzIiwic2VuZGVycyIsInNlbmRlcklkIiwiaSIsInN1YnNjcmlwdGlvbnMiLCJyZWNlaXZlcnNNYXAiLCJsZW5ndGgiLCJwdXNoIiwicmVjZWl2ZXJPYmplY3RNYW5hZ2VyIiwiZ2V0T2JqZWN0Iiwic2VuZGVyc01hcCIsInNlbmRlck9iamVjdE1hbmFnZXIiLCJzdWJzY3JpcHRpb24iLCJhcHBseSIsInJhaXNlRXZlbnQiLCJtZXNzYWdlIiwiZXZlbnRzIiwiaiIsImV2ZW50IiwiaGFzT2JqZWN0IiwiYWRkTW9kaWZpY2F0aW9uSGFuZGxlciIsIm1vZGlmaWNhdGlvbkhhbmRsZXIiLCJtb2RpZmljYXRpb25IYW5kbGVycyIsImFjdGlvbiIsIm5vdGlmeSIsIl9jcmVhdGVFdmVudERhdGEiLCJpZCIsImdlbmVyYXRlSWQiLCJzZW5kZXJFdmVudERhdGEiLCJyZWNlaXZlckV2ZW50RGF0YSIsInJlZ2lzdGVyT2JqZWN0IiwibnVtRGVsIiwicmVtb3ZlT2JqZWN0Iiwic3VjY2VzcyIsIl9zZW5kZXJIYXNSZWNlaXZlciIsImRlbGV0ZU9iamVjdCIsImlzRW1wdHkiLCJfcmVjZWl2ZXJIYXNTZW5kZXIiLCJfcmVjZWl2ZXJIYXNTaWduYWxTZW5kZXIiXSwibWFwcGluZ3MiOiI7O0FBQUFBLE1BQU0sQ0FBQyxDQUFDLFFBQUQsRUFBVyxpQkFBWCxDQUFELEVBQWdDLFVBQVVDLElBQVYsRUFBZ0JDLGFBQWhCLEVBQStCO0FBRWpFLE1BQUlDLE1BQU0sR0FBRztBQUVUQyxJQUFBQSxpQkFBaUIsRUFBRSxjQUZWO0FBSVRDLElBQUFBLFdBQVcsRUFBRSxDQUpKO0FBTVRDLElBQUFBLGlCQUFpQixFQUFFLDZCQUFZO0FBQzNCLGFBQU9ILE1BQU0sQ0FBQ0UsV0FBZDtBQUNILEtBUlE7QUFVVEUsSUFBQUEsZUFBZSxFQUFFLHlCQUFVQyxNQUFWLEVBQWtCQyxNQUFsQixFQUEwQkMsUUFBMUIsRUFBb0NDLE9BQXBDLEVBQTZDO0FBQzFELFVBQUlSLE1BQU0sQ0FBQ1Msd0JBQVAsQ0FBZ0NKLE1BQWhDLEVBQXdDQyxNQUF4QyxFQUFnREMsUUFBaEQsQ0FBSixFQUErRDtBQUMzRDtBQUNIOztBQUNEUCxNQUFBQSxNQUFNLENBQUNVLDJCQUFQLENBQW1DLEtBQW5DLEVBQTBDTCxNQUExQyxFQUFrREMsTUFBbEQsRUFBMERDLFFBQTFELEVBQW9FQyxPQUFwRTs7QUFDQSxVQUFJRyxRQUFRLEdBQUdYLE1BQU0sQ0FBQ1kseUJBQVAsQ0FBaUNQLE1BQWpDLEVBQXlDQyxNQUF6QyxFQUFpREMsUUFBakQsRUFBMkRDLE9BQTNELENBQWY7O0FBQ0EsVUFBSUssUUFBUSxHQUFHYixNQUFNLENBQUNjLHlCQUFQLENBQWlDVCxNQUFqQyxFQUF5Q0MsTUFBekMsRUFBaURDLFFBQWpELEVBQTJEQyxPQUEzRCxDQUFmOztBQUNBLFVBQUksQ0FBQ0csUUFBRCxJQUFhLENBQUNFLFFBQWxCLEVBQTRCO0FBQ3hCLGNBQU0sZUFB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QixVQUFsQixDQUE2QjVCLE1BQTdCLENBQVA7QUFDSDs7QUFDRCxhQUFPbUQsT0FBUDtBQUNIO0FBOVJRLEdBQWI7QUFrU0EsU0FBT3pELE1BQVA7QUFFSCxDQXRTSyxDQUFOIiwic291cmNlc0NvbnRlbnQiOlsiZGVmaW5lKFsnLi9jb3JlJywgJy4vT2JqZWN0TWFuYWdlciddLCBmdW5jdGlvbiAoY29yZSwgT2JqZWN0TWFuYWdlcikge1xuXG4gICAgdmFyIG1vZHVsZSA9IHtcblxuICAgICAgICBldmVudERhdGFQcm9wZXJ0eTogJ19fdHRfZXZlbnRfXycsXG5cbiAgICAgICAgbnVtSGFuZGxlcnM6IDAsXG5cbiAgICAgICAgZ2V0TnVtYmVySGFuZGxlcnM6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiBtb2R1bGUubnVtSGFuZGxlcnM7XG4gICAgICAgIH0sXG5cbiAgICAgICAgYWRkRXZlbnRIYW5kbGVyOiBmdW5jdGlvbiAoc2VuZGVyLCBzaWduYWwsIHJlY2VpdmVyLCBoYW5kbGVyKSB7XG4gICAgICAgICAgICBpZiAobW9kdWxlLl9zZW5kZXJIYXNTaWduYWxSZWNlaXZlcihzZW5kZXIsIHNpZ25hbCwgcmVjZWl2ZXIpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbW9kdWxlLl9ub3RpZnlNb2RpZmljYXRpb25IYW5kbGVycygnYWRkJywgc2VuZGVyLCBzaWduYWwsIHJlY2VpdmVyLCBoYW5kbGVyKTtcbiAgICAgICAgICAgIHZhciBzdWNjZXNzMSA9IG1vZHVsZS5fYWRkRXZlbnRTZW5kZXJUb1JlY2VpdmVyKHNlbmRlciwgc2lnbmFsLCByZWNlaXZlciwgaGFuZGxlcik7XG4gICAgICAgICAgICB2YXIgc3VjY2VzczIgPSBtb2R1bGUuX2FkZEV2ZW50UmVjZWl2ZXJUb1NlbmRlcihzZW5kZXIsIHNpZ25hbCwgcmVjZWl2ZXIsIGhhbmRsZXIpO1xuICAgICAgICAgICAgaWYgKCFzdWNjZXNzMSB8fCAhc3VjY2VzczIpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyAncHJvZ3JhbSBlcnJvcic7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLm51bUhhbmRsZXJzKys7XG4gICAgICAgIH0sXG5cbiAgICAgICAgcmVtb3ZlRXZlbnRIYW5kbGVyOiBmdW5jdGlvbiAoc2VuZGVyLCBzaWduYWwsIHJlY2VpdmVyLCBoYW5kbGVyKSB7XG4gICAgICAgICAgICBpZiAoIW1vZHVsZS5fc2VuZGVySGFzU2lnbmFsUmVjZWl2ZXIoc2VuZGVyLCBzaWduYWwsIHJlY2VpdmVyKSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG1vZHVsZS5fbm90aWZ5TW9kaWZpY2F0aW9uSGFuZGxlcnMoJ3JlbW92ZScsIHNlbmRlciwgc2lnbmFsLCByZWNlaXZlciwgaGFuZGxlcik7XG5cbiAgICAgICAgICAgIHZhciBzdWNjZXNzMSA9IG1vZHVsZS5fcmVtb3ZlRXZlbnRTZW5kZXJGcm9tUmVjZWl2ZXIoc2VuZGVyLCBzaWduYWwsIHJlY2VpdmVyLCBoYW5kbGVyKTtcbiAgICAgICAgICAgIHZhciBzdWNjZXNzMiA9IG1vZHVsZS5fcmVtb3ZlRXZlbnRSZWNlaXZlckZyb21TZW5kZXIoc2VuZGVyLCBzaWduYWwsIHJlY2VpdmVyLCBoYW5kbGVyKTtcbiAgICAgICAgICAgIGlmICghc3VjY2VzczEgfHwgIXN1Y2Nlc3MyKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgJ3Byb2dyYW0gZXJyb3InO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5udW1IYW5kbGVycy0tO1xuICAgICAgICB9LFxuXG4gICAgICAgIGRlbGV0ZTogZnVuY3Rpb24gKG9iaikge1xuICAgICAgICAgICAgdmFyIGV2ZW50RGF0YSA9IG1vZHVsZS5nZXRFdmVudERhdGEob2JqKTtcbiAgICAgICAgICAgIC8vIGNvbGxlY3QgZXZlbnQgc3Vic2NyaXB0aW9ucyB3aGVyZSBvYmogaXMgc2VuZGVyXG4gICAgICAgICAgICB2YXIgc2lnbmFsLCByZWNlaXZlcnMsIHJlY2VpdmVySWQsIGhhbmRsZXJzLCBzZW5kZXJzLCBzZW5kZXJJZCwgaSwgaGFuZGxlciwgc3Vic2NyaXB0aW9ucztcbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbnMgPSBbXTtcbiAgICAgICAgICAgIGZvciAoc2lnbmFsIGluIGV2ZW50RGF0YS5yZWNlaXZlcnNNYXApIHtcbiAgICAgICAgICAgICAgICByZWNlaXZlcnMgPSBldmVudERhdGEucmVjZWl2ZXJzTWFwW3NpZ25hbF07XG4gICAgICAgICAgICAgICAgZm9yIChyZWNlaXZlcklkIGluIHJlY2VpdmVycykge1xuICAgICAgICAgICAgICAgICAgICBoYW5kbGVycyA9IHJlY2VpdmVyc1tyZWNlaXZlcklkXTtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGhhbmRsZXJzLmxlbmd0aDsgKytpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyID0gaGFuZGxlcnNbaV07XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25zLnB1c2goW29iaiwgc2lnbmFsLCBldmVudERhdGEucmVjZWl2ZXJPYmplY3RNYW5hZ2VyLmdldE9iamVjdChyZWNlaXZlcklkKSwgaGFuZGxlcl0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gY29sbGVjdCBldmVudCBzdWJzY3JpcHRpb25zICB3aGVyZSBvYmogaXMgcmVjZWl2ZXJcbiAgICAgICAgICAgIGZvciAoc2lnbmFsIGluIGV2ZW50RGF0YS5zZW5kZXJzTWFwKSB7XG4gICAgICAgICAgICAgICAgc2VuZGVycyA9IGV2ZW50RGF0YS5zZW5kZXJzTWFwW3NpZ25hbF07XG4gICAgICAgICAgICAgICAgZm9yIChzZW5kZXJJZCBpbiBzZW5kZXJzKSB7XG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzID0gc2VuZGVyc1tzZW5kZXJJZF07XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBoYW5kbGVycy5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlciA9IGhhbmRsZXJzW2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9ucy5wdXNoKFtldmVudERhdGEuc2VuZGVyT2JqZWN0TWFuYWdlci5nZXRPYmplY3Qoc2VuZGVySWQpLCBzaWduYWwsIG9iaiwgaGFuZGxlcl0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gcmVtb3ZlIHN1YnNjcmlwdGlvbnNcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3Vic2NyaXB0aW9ucy5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgICAgIHZhciBzdWJzY3JpcHRpb24gPSBzdWJzY3JpcHRpb25zW2ldO1xuICAgICAgICAgICAgICAgIG1vZHVsZS5yZW1vdmVFdmVudEhhbmRsZXIuYXBwbHkobW9kdWxlLCBzdWJzY3JpcHRpb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuXG4gICAgICAgIHJhaXNlRXZlbnQ6IGZ1bmN0aW9uIChzZW5kZXIsIHNpZ25hbCwgbWVzc2FnZSkge1xuICAgICAgICAgICAgdmFyIGV2ZW50RGF0YSA9IG1vZHVsZS5nZXRFdmVudERhdGEoc2VuZGVyKTtcbiAgICAgICAgICAgIHZhciByZWNlaXZlcnMgPSBldmVudERhdGEucmVjZWl2ZXJzTWFwW3NpZ25hbF07XG4gICAgICAgICAgICBpZiAoIXJlY2VpdmVycykge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIGNvbGxlY3QgZXZlbnRzXG4gICAgICAgICAgICB2YXIgZXZlbnRzID0gW107XG4gICAgICAgICAgICB2YXIgcmVjZWl2ZXJJZCwgaGFuZGxlciwgaGFuZGxlcnM7XG4gICAgICAgICAgICBmb3IgKHJlY2VpdmVySWQgaW4gcmVjZWl2ZXJzKSB7XG4gICAgICAgICAgICAgICAgaGFuZGxlcnMgPSByZWNlaXZlcnNbcmVjZWl2ZXJJZF07XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoYW5kbGVycy5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgICAgICAgICBoYW5kbGVyID0gaGFuZGxlcnNbaV07XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50cy5wdXNoKFtyZWNlaXZlcklkLCBoYW5kbGVyXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gcHJvY2VzcyBldmVudHNcbiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZXZlbnRzLmxlbmd0aDsgKytqKSB7XG4gICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gZXZlbnRzW2pdO1xuICAgICAgICAgICAgICAgIHJlY2VpdmVySWQgPSBldmVudFswXTtcbiAgICAgICAgICAgICAgICBoYW5kbGVyID0gZXZlbnRbMV07XG4gICAgICAgICAgICAgICAgcmVjZWl2ZXJzID0gZXZlbnREYXRhLnJlY2VpdmVyc01hcFtzaWduYWxdO1xuICAgICAgICAgICAgICAgIGlmICghcmVjZWl2ZXJzKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaGFuZGxlcnMgPSByZWNlaXZlcnNbcmVjZWl2ZXJJZF07XG4gICAgICAgICAgICAgICAgaWYgKCFoYW5kbGVycykge1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFjb3JlLmhhc09iamVjdChoYW5kbGVycywgaGFuZGxlcikpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGhhbmRsZXIuYXBwbHkoZXZlbnREYXRhLnJlY2VpdmVyT2JqZWN0TWFuYWdlci5nZXRPYmplY3QocmVjZWl2ZXJJZCksIFtzaWduYWwsIG1lc3NhZ2VdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcblxuICAgICAgICBhZGRNb2RpZmljYXRpb25IYW5kbGVyOiBmdW5jdGlvbiAob2JqLCBtb2RpZmljYXRpb25IYW5kbGVyKSB7XG4gICAgICAgICAgICB2YXIgZXZlbnREYXRhID0gbW9kdWxlLmdldEV2ZW50RGF0YShvYmopO1xuICAgICAgICAgICAgaWYgKGNvcmUuaGFzT2JqZWN0KGV2ZW50RGF0YS5tb2RpZmljYXRpb25IYW5kbGVycywgbW9kaWZpY2F0aW9uSGFuZGxlcikpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBldmVudERhdGEubW9kaWZpY2F0aW9uSGFuZGxlcnMucHVzaChtb2RpZmljYXRpb25IYW5kbGVyKTtcbiAgICAgICAgfSxcblxuICAgICAgICBfbm90aWZ5TW9kaWZpY2F0aW9uSGFuZGxlcnM6IGZ1bmN0aW9uIChhY3Rpb24sIHNlbmRlciwgc2lnbmFsLCByZWNlaXZlciwgaGFuZGxlcikge1xuICAgICAgICAgICAgdmFyIG5vdGlmeSA9IGZ1bmN0aW9uIChtb2RpZmljYXRpb25IYW5kbGVycykge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbW9kaWZpY2F0aW9uSGFuZGxlcnMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1vZGlmaWNhdGlvbkhhbmRsZXIgPSBtb2RpZmljYXRpb25IYW5kbGVyc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgbW9kaWZpY2F0aW9uSGFuZGxlcihhY3Rpb24sIHNlbmRlciwgc2lnbmFsLCByZWNlaXZlciwgaGFuZGxlcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbm90aWZ5KG1vZHVsZS5nZXRFdmVudERhdGEoc2VuZGVyKS5tb2RpZmljYXRpb25IYW5kbGVycyk7XG4gICAgICAgICAgICBub3RpZnkobW9kdWxlLmdldEV2ZW50RGF0YShyZWNlaXZlcikubW9kaWZpY2F0aW9uSGFuZGxlcnMpO1xuICAgICAgICB9LFxuXG4gICAgICAgIGdldEV2ZW50RGF0YTogZnVuY3Rpb24gKG9iaikge1xuICAgICAgICAgICAgdmFyIGV2ZW50RGF0YSA9IG9ialt0aGlzLmV2ZW50RGF0YVByb3BlcnR5XTtcbiAgICAgICAgICAgIGlmIChldmVudERhdGEpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnREYXRhO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZXZlbnREYXRhID0gbW9kdWxlLl9jcmVhdGVFdmVudERhdGEoKTtcbiAgICAgICAgICAgIG9ialt0aGlzLmV2ZW50RGF0YVByb3BlcnR5XSA9IGV2ZW50RGF0YTtcbiAgICAgICAgICAgIHJldHVybiBldmVudERhdGE7XG4gICAgICAgIH0sXG5cbiAgICAgICAgX2NyZWF0ZUV2ZW50RGF0YTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIGV2ZW50RGF0YSA9IHt9O1xuICAgICAgICAgICAgZXZlbnREYXRhLnJlY2VpdmVyc01hcCA9IHt9OyAvLyB7IHNpZ25hbCA6IHsgcmVjZWl2ZXJJZCA6IFtoYW5kbGVyXX19XG4gICAgICAgICAgICBldmVudERhdGEuc2VuZGVyc01hcCA9IHt9OyAvLyB7IHNpZ25hbCA6IHsgc2VuZGVySWQ6ICBbaGFuZGxlcl19fVxuICAgICAgICAgICAgZXZlbnREYXRhLmlkID0gY29yZS5nZW5lcmF0ZUlkKCk7XG4gICAgICAgICAgICBldmVudERhdGEucmVjZWl2ZXJPYmplY3RNYW5hZ2VyID0gbmV3IE9iamVjdE1hbmFnZXIoKTtcbiAgICAgICAgICAgIGV2ZW50RGF0YS5zZW5kZXJPYmplY3RNYW5hZ2VyID0gbmV3IE9iamVjdE1hbmFnZXIoKTtcbiAgICAgICAgICAgIGV2ZW50RGF0YS5tb2RpZmljYXRpb25IYW5kbGVycyA9IFtdO1xuICAgICAgICAgICAgcmV0dXJuIGV2ZW50RGF0YTtcbiAgICAgICAgfSxcblxuICAgICAgICBfYWRkRXZlbnRSZWNlaXZlclRvU2VuZGVyOiBmdW5jdGlvbiAoc2VuZGVyLCBzaWduYWwsIHJlY2VpdmVyLCBoYW5kbGVyKSB7XG4gICAgICAgICAgICB2YXIgc2VuZGVyRXZlbnREYXRhID0gbW9kdWxlLmdldEV2ZW50RGF0YShzZW5kZXIpO1xuICAgICAgICAgICAgdmFyIHJlY2VpdmVyRXZlbnREYXRhID0gbW9kdWxlLmdldEV2ZW50RGF0YShyZWNlaXZlcik7XG4gICAgICAgICAgICBzZW5kZXJFdmVudERhdGEucmVjZWl2ZXJPYmplY3RNYW5hZ2VyLnJlZ2lzdGVyT2JqZWN0KHJlY2VpdmVyRXZlbnREYXRhLmlkLCByZWNlaXZlcik7XG4gICAgICAgICAgICB2YXIgcmVjZWl2ZXJzID0gc2VuZGVyRXZlbnREYXRhLnJlY2VpdmVyc01hcFtzaWduYWxdO1xuICAgICAgICAgICAgaWYgKCFyZWNlaXZlcnMpIHtcbiAgICAgICAgICAgICAgICBzZW5kZXJFdmVudERhdGEucmVjZWl2ZXJzTWFwW3NpZ25hbF0gPSByZWNlaXZlcnMgPSB7fTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBoYW5kbGVycyA9IHJlY2VpdmVyc1tyZWNlaXZlckV2ZW50RGF0YS5pZF07XG4gICAgICAgICAgICBpZiAoIWhhbmRsZXJzKSB7XG4gICAgICAgICAgICAgICAgcmVjZWl2ZXJzW3JlY2VpdmVyRXZlbnREYXRhLmlkXSA9IGhhbmRsZXJzID0gW107XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoY29yZS5oYXNPYmplY3QoaGFuZGxlcnMsIGhhbmRsZXIpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaGFuZGxlcnMucHVzaChoYW5kbGVyKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9LFxuXG4gICAgICAgIF9yZW1vdmVFdmVudFJlY2VpdmVyRnJvbVNlbmRlcjogZnVuY3Rpb24gKHNlbmRlciwgc2lnbmFsLCByZWNlaXZlciwgaGFuZGxlcikge1xuICAgICAgICAgICAgdmFyIHNlbmRlckV2ZW50RGF0YSA9IG1vZHVsZS5nZXRFdmVudERhdGEoc2VuZGVyKTtcbiAgICAgICAgICAgIHZhciByZWNlaXZlckV2ZW50RGF0YSA9IG1vZHVsZS5nZXRFdmVudERhdGEocmVjZWl2ZXIpO1xuICAgICAgICAgICAgdmFyIHJlY2VpdmVycyA9IHNlbmRlckV2ZW50RGF0YS5yZWNlaXZlcnNNYXBbc2lnbmFsXTtcbiAgICAgICAgICAgIGlmICghcmVjZWl2ZXJzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIGhhbmRsZXJzID0gcmVjZWl2ZXJzW3JlY2VpdmVyRXZlbnREYXRhLmlkXTtcbiAgICAgICAgICAgIGlmICghaGFuZGxlcnMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgbnVtRGVsID0gY29yZS5yZW1vdmVPYmplY3QoaGFuZGxlcnMsIGhhbmRsZXIpO1xuICAgICAgICAgICAgdmFyIHN1Y2Nlc3MgPSBudW1EZWwgPiAwO1xuICAgICAgICAgICAgaWYgKGhhbmRsZXJzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSByZWNlaXZlcnNbcmVjZWl2ZXJFdmVudERhdGEuaWRdO1xuICAgICAgICAgICAgICAgIGlmICghbW9kdWxlLl9zZW5kZXJIYXNSZWNlaXZlcihzZW5kZXIsIHJlY2VpdmVyKSkge1xuICAgICAgICAgICAgICAgICAgICBzZW5kZXJFdmVudERhdGEucmVjZWl2ZXJPYmplY3RNYW5hZ2VyLmRlbGV0ZU9iamVjdChyZWNlaXZlckV2ZW50RGF0YS5pZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGNvcmUuaXNFbXB0eShyZWNlaXZlcnMpKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHNlbmRlckV2ZW50RGF0YS5yZWNlaXZlcnNNYXBbc2lnbmFsXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBzdWNjZXNzO1xuICAgICAgICB9LFxuXG4gICAgICAgIF9zZW5kZXJIYXNSZWNlaXZlcjogZnVuY3Rpb24gKHNlbmRlciwgcmVjZWl2ZXIpIHtcbiAgICAgICAgICAgIHZhciBzZW5kZXJFdmVudERhdGEgPSBtb2R1bGUuZ2V0RXZlbnREYXRhKHNlbmRlcik7XG4gICAgICAgICAgICB2YXIgcmVjZWl2ZXJFdmVudERhdGEgPSBtb2R1bGUuZ2V0RXZlbnREYXRhKHJlY2VpdmVyKTtcbiAgICAgICAgICAgIGZvciAodmFyIHNpZ25hbCBpbiBzZW5kZXJFdmVudERhdGEucmVjZWl2ZXJzTWFwKSB7XG4gICAgICAgICAgICAgICAgdmFyIHJlY2VpdmVycyA9IHNlbmRlckV2ZW50RGF0YS5yZWNlaXZlcnNNYXBbc2lnbmFsXTtcbiAgICAgICAgICAgICAgICB2YXIgaGFuZGxlcnMgPSByZWNlaXZlcnNbcmVjZWl2ZXJFdmVudERhdGEuaWRdO1xuICAgICAgICAgICAgICAgIGlmIChoYW5kbGVycykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0sXG5cbiAgICAgICAgX3NlbmRlckhhc1NpZ25hbFJlY2VpdmVyOiBmdW5jdGlvbiAoc2VuZGVyLCBzaWduYWwsIHJlY2VpdmVyKSB7XG4gICAgICAgICAgICB2YXIgc2VuZGVyRXZlbnREYXRhID0gbW9kdWxlLmdldEV2ZW50RGF0YShzZW5kZXIpO1xuICAgICAgICAgICAgdmFyIHJlY2VpdmVyRXZlbnREYXRhID0gbW9kdWxlLmdldEV2ZW50RGF0YShyZWNlaXZlcik7XG4gICAgICAgICAgICB2YXIgcmVjZWl2ZXJzID0gc2VuZGVyRXZlbnREYXRhLnJlY2VpdmVyc01hcFtzaWduYWxdO1xuICAgICAgICAgICAgaWYgKCFyZWNlaXZlcnMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgaGFuZGxlcnMgPSByZWNlaXZlcnNbcmVjZWl2ZXJFdmVudERhdGEuaWRdO1xuICAgICAgICAgICAgaWYgKCFoYW5kbGVycykge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9LFxuXG4gICAgICAgIF9yZWNlaXZlckhhc1NlbmRlcjogZnVuY3Rpb24gKHJlY2VpdmVyLCBzZW5kZXIpIHtcbiAgICAgICAgICAgIHZhciBzZW5kZXJFdmVudERhdGEgPSBtb2R1bGUuZ2V0RXZlbnREYXRhKHNlbmRlcik7XG4gICAgICAgICAgICB2YXIgcmVjZWl2ZXJFdmVudERhdGEgPSBtb2R1bGUuZ2V0RXZlbnREYXRhKHJlY2VpdmVyKTtcbiAgICAgICAgICAgIGZvciAodmFyIHNpZ25hbCBpbiByZWNlaXZlckV2ZW50RGF0YS5zZW5kZXJzTWFwKSB7XG4gICAgICAgICAgICAgICAgdmFyIHNlbmRlcnMgPSByZWNlaXZlckV2ZW50RGF0YS5zZW5kZXJzTWFwW3NpZ25hbF07XG4gICAgICAgICAgICAgICAgdmFyIGhhbmRsZXJzID0gc2VuZGVyc1tzZW5kZXJFdmVudERhdGEuaWRdO1xuICAgICAgICAgICAgICAgIGlmIChoYW5kbGVycykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0sXG5cbiAgICAgICAgX3JlY2VpdmVySGFzU2lnbmFsU2VuZGVyOiBmdW5jdGlvbiAocmVjZWl2ZXIsIHNpZ25hbCwgc2VuZGVyKSB7XG4gICAgICAgICAgICB2YXIgc2VuZGVyRXZlbnREYXRhID0gbW9kdWxlLmdldEV2ZW50RGF0YShzZW5kZXIpO1xuICAgICAgICAgICAgdmFyIHJlY2VpdmVyRXZlbnREYXRhID0gbW9kdWxlLmdldEV2ZW50RGF0YShyZWNlaXZlcik7XG4gICAgICAgICAgICB2YXIgc2VuZGVycyA9IHJlY2VpdmVyRXZlbnREYXRhLnNlbmRlcnNNYXBbc2lnbmFsXTtcbiAgICAgICAgICAgIGlmICghc2VuZGVycykge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBoYW5kbGVycyA9IHNlbmRlcnNbc2VuZGVyRXZlbnREYXRhLmlkXTtcbiAgICAgICAgICAgIGlmICghaGFuZGxlcnMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0sXG5cbiAgICAgICAgX2FkZEV2ZW50U2VuZGVyVG9SZWNlaXZlcjogZnVuY3Rpb24gKHNlbmRlciwgc2lnbmFsLCByZWNlaXZlciwgaGFuZGxlcikge1xuICAgICAgICAgICAgdmFyIHNlbmRlckV2ZW50RGF0YSA9IG1vZHVsZS5nZXRFdmVudERhdGEoc2VuZGVyKTtcbiAgICAgICAgICAgIHZhciByZWNlaXZlckV2ZW50RGF0YSA9IG1vZHVsZS5nZXRFdmVudERhdGEocmVjZWl2ZXIpO1xuICAgICAgICAgICAgcmVjZWl2ZXJFdmVudERhdGEuc2VuZGVyT2JqZWN0TWFuYWdlci5yZWdpc3Rlck9iamVjdChzZW5kZXJFdmVudERhdGEuaWQsIHNlbmRlcik7XG4gICAgICAgICAgICB2YXIgc2VuZGVycyA9IHJlY2VpdmVyRXZlbnREYXRhLnNlbmRlcnNNYXBbc2lnbmFsXTtcbiAgICAgICAgICAgIGlmICghc2VuZGVycykge1xuICAgICAgICAgICAgICAgIHJlY2VpdmVyRXZlbnREYXRhLnNlbmRlcnNNYXBbc2lnbmFsXSA9IHNlbmRlcnMgPSB7fTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBoYW5kbGVycyA9IHNlbmRlcnNbc2VuZGVyRXZlbnREYXRhLmlkXTtcbiAgICAgICAgICAgIGlmICghaGFuZGxlcnMpIHtcbiAgICAgICAgICAgICAgICBzZW5kZXJzW3NlbmRlckV2ZW50RGF0YS5pZF0gPSBoYW5kbGVycyA9IFtdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGNvcmUuaGFzT2JqZWN0KGhhbmRsZXJzLCBoYW5kbGVyKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGhhbmRsZXJzLnB1c2goaGFuZGxlcik7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSxcblxuICAgICAgICBfcmVtb3ZlRXZlbnRTZW5kZXJGcm9tUmVjZWl2ZXI6IGZ1bmN0aW9uIChzZW5kZXIsIHNpZ25hbCwgcmVjZWl2ZXIsIGhhbmRsZXIpIHtcbiAgICAgICAgICAgIHZhciBzZW5kZXJFdmVudERhdGEgPSBtb2R1bGUuZ2V0RXZlbnREYXRhKHNlbmRlcik7XG4gICAgICAgICAgICB2YXIgcmVjZWl2ZXJFdmVudERhdGEgPSBtb2R1bGUuZ2V0RXZlbnREYXRhKHJlY2VpdmVyKTtcbiAgICAgICAgICAgIHZhciBzZW5kZXJzID0gcmVjZWl2ZXJFdmVudERhdGEuc2VuZGVyc01hcFtzaWduYWxdO1xuICAgICAgICAgICAgaWYgKCFzZW5kZXJzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIGhhbmRsZXJzID0gc2VuZGVyc1tzZW5kZXJFdmVudERhdGEuaWRdO1xuICAgICAgICAgICAgaWYgKCFoYW5kbGVycykge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBudW1EZWwgPSBjb3JlLnJlbW92ZU9iamVjdChoYW5kbGVycywgaGFuZGxlcik7XG4gICAgICAgICAgICB2YXIgc3VjY2VzcyA9IG51bURlbCA+IDA7XG4gICAgICAgICAgICBpZiAoaGFuZGxlcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHNlbmRlcnNbc2VuZGVyRXZlbnREYXRhLmlkXTtcbiAgICAgICAgICAgICAgICBpZiAoIW1vZHVsZS5fcmVjZWl2ZXJIYXNTZW5kZXIocmVjZWl2ZXIsIHNlbmRlcikpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVjZWl2ZXJFdmVudERhdGEuc2VuZGVyT2JqZWN0TWFuYWdlci5kZWxldGVPYmplY3Qoc2VuZGVyRXZlbnREYXRhLmlkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoY29yZS5pc0VtcHR5KHNlbmRlcnMpKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHJlY2VpdmVyRXZlbnREYXRhLnNlbmRlcnNNYXBbc2lnbmFsXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBzdWNjZXNzO1xuICAgICAgICB9LFxuXG4gICAgfTtcblxuICAgIHJldHVybiBtb2R1bGU7XG5cbn0pOyJdfQ==